<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechAssess Pro - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #1a1a1a; --primary-hover: #2a2a2a; --secondary: #f8f9fa; --accent: #e9ecef; --success: #22c55e; --warning: #f59e0b; --error: #ef4444; --text-primary: #1a1a1a; --text-secondary: #6b7280; --border: #e5e7eb; --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); --radius: 8px; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #ffffff; color: var(--text-primary); line-height: 1.5; overflow: hidden; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 8px; }
        .toast { background: white; border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); min-width: 320px; max-width: 400px; display: flex; align-items: flex-start; gap: 12px; animation: slideInRight 0.3s ease; }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.warning { border-left: 4px solid var(--warning); }
        .toast.error { border-left: 4px solid var(--error); }
        .toast.info { border-left: 4px solid var(--primary); }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .admin-layout { display: flex; height: 100vh; }
        .sidebar { width: 280px; background: white; border-right: 1px solid var(--border); flex-shrink: 0; display: flex; flex-direction: column; overflow: hidden; }
        .sidebar-header { padding: 24px; border-bottom: 1px solid var(--border); background: var(--secondary); }
        .brand-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .brand-logo { width: 48px; height: 48px; background: var(--primary); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px; }
        .brand-info h1 { font-size: 18px; font-weight: 600; margin-bottom: 2px; }
        .brand-info p { font-size: 13px; color: var(--text-secondary); }
        .sidebar-nav { flex: 1; padding: 16px 0; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 24px; color: var(--text-primary); text-decoration: none; transition: all 0.2s; border: none; background: none; width: 100%; cursor: pointer; font-size: 14px; font-weight: 500; font-family: inherit; }
        .nav-item:hover, .nav-item.active { background: var(--secondary); color: var(--primary); }
        .main-content { flex: 1; background: var(--secondary); overflow: hidden; display: flex; flex-direction: column; }
        .content-panels { flex: 1; overflow: hidden; position: relative; }
        .panel { position: absolute; top: 0; left: 0; right: 0; bottom: 0; padding: 24px; overflow-y: auto; background: var(--secondary); opacity: 0; transform: translateX(20px); transition: all 0.3s ease; pointer-events: none; }
        .panel.active { opacity: 1; transform: translateX(0); pointer-events: all; }
        .page-header { margin-bottom: 24px; }
        .page-header h2 { font-size: 24px; font-weight: 600; margin-bottom: 4px; }
        .page-header p { color: var(--text-secondary); font-size: 14px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: white; border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
        .stat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .stat-title { color: var(--text-secondary); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .stat-icon.primary { background: #f0f0f0; color: var(--primary); }
        .stat-icon.success { background: #f0fdf4; color: var(--success); }
        .stat-icon.warning { background: #fefce8; color: var(--warning); }
        .stat-icon.error { background: #fef2f2; color: var(--error); }
        .stat-value { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
        .stat-description { color: var(--text-secondary); font-size: 13px; }
        .card { background: white; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; margin-bottom: 24px; }
        .card-header { padding: 20px; border-bottom: 1px solid var(--border); background: var(--secondary); display: flex; justify-content: space-between; align-items: center; }
        .card-header h3 { font-size: 16px; font-weight: 600; }
        .card-body { padding: 20px; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); font-size: 13px; }
        .table th { background: var(--secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); }
        .table tbody tr:hover { background: var(--secondary); }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-weight: 500; font-size: 14px; margin-bottom: 6px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 14px; background: white; transition: border-color 0.2s; font-family: inherit; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); }
        .form-textarea { min-height: 80px; resize: vertical; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 16px; border: 1px solid transparent; border-radius: var(--radius); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; text-decoration: none; font-family: inherit; }
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary:hover { background: var(--primary-hover); border-color: var(--primary-hover); }
        .btn-secondary { background: white; color: var(--text-primary); border-color: var(--border); }
        .btn-secondary:hover { background: var(--secondary); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .badge { display: inline-flex; align-items: center; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-success { background: #f0fdf4; color: #166534; }
        .badge-warning { background: #fefce8; color: #854d0e; }
        .badge-error { background: #fef2f2; color: #991b1b; }
        .badge-secondary { background: var(--accent); color: var(--text-secondary); }
        .auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .auth-card { background: white; border-radius: var(--radius); padding: 40px; width: 100%; max-width: 400px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); }
        .auth-header { text-align: center; margin-bottom: 32px; }
        .auth-header h1 { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
        .auth-header p { color: var(--text-secondary); font-size: 14px; }
        .hidden { display: none !important; }
        @media (max-width: 768px) { .admin-layout { flex-direction: column; } .sidebar { width: 100%; height: auto; } .panel { padding: 16px; } .stats-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="toastContainer" class="toast-container"></div>

    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="brand-header" style="justify-content: center; margin-bottom: 16px;"><div class="brand-logo">TA</div></div>
                <h1>Admin Login</h1><p>Sign in to access the dashboard</p>
            </div>
            <form id="loginForm">
                <div class="form-group"><label class="form-label">Email Address</label><input type="email" id="loginEmail" class="form-input" placeholder="admin@demo.com" required></div>
                <div class="form-group"><label class="form-label">Password</label><input type="password" id="loginPassword" class="form-input" placeholder="demo123" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;"><i class="fas fa-sign-in-alt"></i> Sign In</button>
            </form>
        </div>
    </div>

    <div id="dashboardScreen" class="admin-layout hidden">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="brand-header"><div class="brand-logo" id="sidebarLogo">TA</div><div class="brand-info"><h1 id="companyNameDisplay">TechAssess Pro</h1><p>Admin Dashboard</p></div></div>
            </div>
            <nav class="sidebar-nav">
                <button class="nav-item active" onclick="showPanel('dashboard')"><i class="fas fa-chart-bar"></i> Dashboard</button>
                <button class="nav-item" onclick="showPanel('submissions')"><i class="fas fa-file-alt"></i> Submissions</button>
                <button class="nav-item" onclick="showPanel('invitations')"><i class="fas fa-envelope"></i> Invitations</button>
                <button class="nav-item" onclick="showPanel('templates')"><i class="fas fa-layer-group"></i> Templates</button>
                <button class="nav-item" onclick="showPanel('settings')"><i class="fas fa-cog"></i> Settings</button>
                <button class="nav-item" onclick="logout()" style="margin-top: auto; color: var(--error);"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </nav>
        </div>
        <div class="main-content">
            <div class="content-panels">
                <div id="dashboard-panel" class="panel active">
                    <div class="page-header"><h2>Dashboard</h2><p>Overview of assessment activity</p></div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-header"><span class="stat-title">Total Submissions</span><div class="stat-icon primary"><i class="fas fa-file-alt"></i></div></div><div class="stat-value" id="totalSubmissions">0</div></div>
                        <div class="stat-card"><div class="stat-header"><span class="stat-title">Active Assessments</span><div class="stat-icon success"><i class="fas fa-play-circle"></i></div></div><div class="stat-value" id="activeAssessments">0</div></div>
                        <div class="stat-card"><div class="stat-header"><span class="stat-title">Security Incidents</span><div class="stat-icon error"><i class="fas fa-shield-alt"></i></div></div><div class="stat-value" id="securityIncidents">0</div></div>
                        <div class="stat-card"><div class="stat-header"><span class="stat-title">Average Score</span><div class="stat-icon warning"><i class="fas fa-chart-line"></i></div></div><div class="stat-value" id="averageScore">0%</div></div>
                    </div>
                    <div class="card"><div class="card-header"><h3>Recent Submissions</h3><button class="btn btn-secondary btn-sm" onclick="loadDashboardData()"><i class="fas fa-sync-alt"></i> Refresh</button></div><div class="card-body"><table class="table"><thead><tr><th>Candidate</th><th>Assessment</th><th>Submitted</th><th>Actions</th></tr></thead><tbody id="recentSubmissions"></tbody></table></div></div>
                </div>
                <div id="submissions-panel" class="panel">
                    <div class="page-header"><h2>Submissions</h2><p>Review and analyze all submissions</p></div>
                    <div class="card"><div class="card-header"><h3>All Submissions</h3><button class="btn btn-secondary btn-sm" onclick="loadSubmissions()"><i class="fas fa-sync-alt"></i> Refresh</button></div><div class="card-body"><table class="table"><thead><tr><th>Candidate</th><th>Email</th><th>Assessment</th><th>Submitted</th><th>Actions</th></tr></thead><tbody id="allSubmissions"></tbody></table></div></div>
                </div>
                <div id="invitations-panel" class="panel">
                    <div class="page-header"><h2>Invitations</h2><p>Create and manage invitations</p></div>
                    <div class="card"><div class="card-header"><h3>Create Invitation</h3></div><div class="card-body"><form id="invitationForm"><div class="form-group"><label class="form-label">Candidate Email</label><input type="email" id="candidateEmail" class="form-input" required></div><div class="form-group"><label class="form-label">Assessment Template</label><select id="assessmentTemplate" class="form-select" required><option value="">Loading...</option></select></div><div class="form-group"><label class="form-label">Expiration Date</label><input type="datetime-local" id="expirationDate" class="form-input" required></div><button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Send</button></form></div></div>
                    <div class="card"><div class="card-header"><h3>Recent Invitations</h3><button class="btn btn-secondary btn-sm" onclick="loadInvitations()"><i class="fas fa-sync-alt"></i> Refresh</button></div><div class="card-body"><table class="table"><thead><tr><th>Candidate</th><th>Assessment</th><th>Status</th><th>Actions</th></tr></thead><tbody id="invitationsList"></tbody></table></div></div>
                </div>
                <div id="templates-panel" class="panel">
                    <div class="page-header"><h2>Templates</h2><p>Manage assessment templates</p></div>
                    <div class="card"><div class="card-header"><h3>Available Templates</h3></div><div class="card-body" id="templatesList"></div></div>
                </div>
                <div id="settings-panel" class="panel">
                    <div class="page-header"><h2>Settings</h2><p>Configure platform settings</p></div>
                    <div class="card"><div class="card-header"><h3>Database Configuration</h3></div><div class="card-body"><form id="databaseForm"><div class="form-group"><label class="form-label">Supabase URL</label><input type="url" id="supabaseUrl" class="form-input" placeholder="https://your-project.supabase.co"></div><div class="form-group"><label class="form-label">Supabase Service Role Key</label><input type="password" id="supabaseKey" class="form-input" placeholder="Enter service role key"></div><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save</button></form></div></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const CONFIG = { supabaseUrl: "https://ytoidmelmialrjfqyhet.supabase.co", supabaseServiceKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0b2lkbWVsbWlhbHJqZnF5aGV0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTY4NzA2MjU0MiwiZXhwIjoyMDAyNjM4NTQyfQ.PLACEHOLDER_KEY" };
        let supabaseClient = null;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginForm').addEventListener('submit', e => { e.preventDefault(); login(document.getElementById('loginEmail').value, document.getElementById('loginPassword').value); });
            document.getElementById('databaseForm').addEventListener('submit', e => { e.preventDefault(); saveDatabaseSettings(); });
            document.getElementById('invitationForm').addEventListener('submit', e => { e.preventDefault(); createInvitation(); });
            
            const storedUrl = localStorage.getItem('supabaseUrl');
            const storedKey = localStorage.getItem('supabaseKey');
            if (storedUrl && storedKey) {
                document.getElementById('supabaseUrl').value = storedUrl;
                document.getElementById('supabaseKey').value = storedKey;
                initializeSupabase(storedUrl, storedKey);
            }
            showAuthScreen();
        });

        function initializeSupabase(url, key) {
            try {
                supabaseClient = supabase.createClient(url, key);
                console.log('✅ Supabase initialized');
                return true;
            } catch (error) {
                console.error('❌ Supabase init failed:', error);
                showToast('DB Error', 'Failed to connect. Check credentials.', 'error');
                return false;
            }
        }

        async function login(email, password) {
            if (email === 'admin@demo.com' && password === 'demo123') {
                showToast('Login Successful', 'Welcome to the demo dashboard.', 'success');
                showDashboard();
                return;
            }
            if (!supabaseClient) return showToast('DB Error', 'Please configure database in Settings.', 'error');
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) return showToast('Login Failed', error.message, 'error');
            showDashboard();
        }
        
        async function logout() {
            if(supabaseClient) await supabaseClient.auth.signOut();
            showAuthScreen();
        }

        function showAuthScreen() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('dashboardScreen').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.remove('hidden');
            loadAllData();
        }

        function showPanel(panelName) {
            document.querySelectorAll('.nav-item, .panel').forEach(el => el.classList.remove('active'));
            document.querySelector(`.nav-item[onclick="showPanel('${panelName}')"]`).classList.add('active');
            document.getElementById(`${panelName}-panel`).classList.add('active');
            const loadFunc = {
                'dashboard': loadDashboardData,
                'submissions': loadSubmissions,
                'invitations': loadInvitations,
                'templates': loadTemplates,
            }[panelName];
            if (loadFunc) loadFunc();
        }
        
        function loadAllData() {
            if (!supabaseClient) {
                showToast('Demo Mode', 'Connect to a database in Settings to see live data.', 'info');
                return;
            }
            loadDashboardData();
            loadSubmissions();
            loadInvitations();
            loadTemplates();
        }

        async function loadDashboardData() { /* Full logic to load stats */ }
        async function loadSubmissions() {
            const tbody = document.getElementById('allSubmissions');
            tbody.innerHTML = `<tr><td colspan="5">Loading...</td></tr>`;
            if (!supabaseClient) return tbody.innerHTML = `<tr><td colspan="5">Database not connected.</td></tr>`;
            const { data, error } = await supabaseClient.from('submissions').select('*').order('submitted_at', { ascending: false });
            if (error || !data) return tbody.innerHTML = `<tr><td colspan="5">Error loading submissions.</td></tr>`;
            if (data.length === 0) return tbody.innerHTML = `<tr><td colspan="5">No submissions found.</td></tr>`;
            tbody.innerHTML = data.map(sub => `<tr><td>${sub.candidate_name}</td><td>${sub.candidate_email}</td><td>${sub.assessment_id || 'N/A'}</td><td>${new Date(sub.submitted_at).toLocaleString()}</td><td><button class="btn btn-sm btn-secondary" onclick="viewSubmission(${sub.id})"><i class="fas fa-eye"></i> View</button></td></tr>`).join('');
        }
        async function loadInvitations() { /* Full logic to load invitations */ }
        async function loadTemplates() { /* Full logic to load templates */ }

        async function viewSubmission(id) {
            if (!supabaseClient) return showToast('Error', 'Database not connected.', 'error');
            try {
                const { data: submission, error } = await supabaseClient.from('submissions').select('*').eq('id', id).single();
                if (error) throw error;
                showSubmissionModal(submission);
            } catch (error) {
                console.error('Failed to load submission:', error);
                showToast('Error', 'Failed to load submission details.', 'error');
            }
        }

        function showSubmissionModal(submission) {
            const escapeHTML = str => String(str || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));
            const cheatingLogs = submission.cheating_logs || [];
            const answers = submission.answers || [];
            const questions = submission.questions || [];

            const answersHtml = answers.length > 0 ? answers.map((answer, index) => `<div style="margin-bottom: 16px;"><h5 style="font-size: 13px; font-weight: 600;">Q${index + 1}: ${escapeHTML(questions[index]?.title)}</h5><div style="background: #f8f9fa; border: 1px solid var(--border); padding: 16px; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">${escapeHTML(answer)}</div></div>`).join('') : '<p>No answers submitted.</p>';
            const securityHtml = cheatingLogs.length > 0 ? cheatingLogs.map(log => `<div style="background: #fef2f2; border-left: 4px solid var(--error); padding: 12px; margin-bottom: 8px;"><span>${escapeHTML(log.event)} at ${new Date(log.timestamp).toLocaleTimeString()}</span></div>`).join('') : '<p>No security incidents detected.</p>';

            const modal = document.createElement('div');
            modal.style.cssText = `position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;`;
            modal.innerHTML = `<div style="background: white; border-radius: var(--radius); max-width: 800px; width: 90%; max-height: 90vh; display: flex; flex-direction: column;"><div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items:center;"><h3>Submission Details</h3><button onclick="this.closest('div[style*=\\"position: fixed\\"]').remove()" style="background:none;border:none;cursor:pointer;font-size:1.2rem;">&times;</button></div><div style="padding: 20px; flex: 1; overflow-y: auto;"><div style="margin-bottom: 20px;"><h4>Candidate Information</h4><p><strong>Name:</strong> ${escapeHTML(submission.candidate_name)}</p><p><strong>Email:</strong> ${escapeHTML(submission.candidate_email)}</p></div><div style="margin-bottom: 20px;"><h4>Submitted Answers</h4>${answersHtml}</div><div><h4>Security Events (${cheatingLogs.length})</h4>${securityHtml}</div></div><div style="padding: 20px; border-top: 1px solid var(--border); text-align: right;"><button onclick="this.closest('div[style*=\\"position: fixed\\"]').remove()" class="btn btn-secondary">Close</button></div></div>`;
            document.body.appendChild(modal);
        }
        
        function showToast(title, message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<div><div style="font-weight:600;">${title}</div><p>${message}</p></div><button onclick="this.parentElement.remove()" style="background:none;border:none;cursor:pointer;">&times;</button>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }
        
        function saveDatabaseSettings() {
             const url = document.getElementById('supabaseUrl').value;
             const key = document.getElementById('supabaseKey').value;
             if(url && key && initializeSupabase(url, key)) {
                 localStorage.setItem('supabaseUrl', url);
                 localStorage.setItem('supabaseKey', key);
                 showToast('Success', 'Database settings saved.', 'success');
                 loadAllData();
             } else {
                 showToast('Error', 'Please provide valid credentials.', 'error');
             }
        }
        
        async function createInvitation() { /* Full logic to create invitation */ }

    </script>
</body>
</html>
