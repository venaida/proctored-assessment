<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechAssess Pro - Assessment Platform</title>
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/github.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a1a1a;
            --primary-hover: #2a2a2a;
            --secondary: #f8f9fa;
            --accent: #e9ecef;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --radius: 8px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 320px;
            max-width: 400px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideInRight 0.3s ease;
        }

        .toast.success { border-left: 4px solid var(--success); }
        .toast.warning { border-left: 4px solid var(--warning); }
        .toast.error { border-left: 4px solid var(--error); }
        .toast.info { border-left: 4px solid var(--primary); }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Main Layout */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card {
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            background: var(--secondary);
            padding: 32px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .brand-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .brand-logo {
            width: 60px;
            height: 60px;
            background: var(--primary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 24px;
        }

        .card-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .card-header p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .card-body {
            padding: 32px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 16px;
            background: white;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.1);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px 24px;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            min-height: 48px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(26, 26, 26, 0.2);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--secondary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #16a34a;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
        }

        .btn-group {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 32px;
        }

        /* Info Boxes */
        .info-box {
            background: var(--accent);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin: 20px 0;
        }

        .warning-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-left: 4px solid #f59e0b;
            border-radius: var(--radius);
            padding: 20px;
            margin: 20px 0;
        }

        .warning-box h3 {
            color: #92400e;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Instructions Grid */
        .instructions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }

        .instruction-item {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }

        .instruction-item h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Assessment Layout */
        .assessment-container {
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .assessment-header {
            background: white;
            border-bottom: 2px solid var(--border);
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .assessment-info h2 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .assessment-info p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .assessment-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .timer {
            background: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: 24px;
            font-weight: 700;
            font-family: monospace;
            font-size: 16px;
        }

        .timer.warning { background: var(--warning); color: var(--text-primary); }
        .timer.danger { background: var(--error); }

        .recording-indicator {
            background: var(--error);
            color: white;
            padding: 12px 20px;
            border-radius: 24px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .recording-dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .assessment-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .questions-panel {
            width: 360px;
            background: var(--secondary);
            border-right: 2px solid var(--border);
            padding: 24px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .question-nav {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(48px, 1fr));
            gap: 12px;
            margin-bottom: 32px;
        }

        .question-nav-item {
            width: 48px;
            height: 48px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 700;
            font-size: 16px;
            background: white;
            transition: all 0.2s;
        }

        .question-nav-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .question-nav-item.answered {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .current-question {
            background: white;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
        }

        .current-question h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .current-question p {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 20px;
        }

        .test-cases {
            margin-top: 20px;
        }

        .test-case {
            background: var(--accent);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
        }

        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .editor-header {
            padding: 16px 24px;
            background: var(--secondary);
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-tab {
            background: white;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
        }

        .CodeMirror {
            height: calc(100vh - 200px) !important;
            font-size: 16px;
            font-family: 'Monaco', 'Consolas', monospace;
            border: none;
        }

        .status-bar {
            padding: 16px 24px;
            background: var(--secondary);
            border-top: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Success Screen */
        .success-screen {
            text-align: center;
            padding: 48px 32px;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            color: white;
            font-size: 32px;
        }

        .hidden {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 20px 10px;
            }

            .assessment-content {
                flex-direction: column;
            }

            .questions-panel {
                width: 100%;
                max-height: 250px;
                border-right: none;
                border-bottom: 2px solid var(--border);
            }

            .CodeMirror {
                height: calc(100vh - 350px) !important;
            }

            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Content will be dynamically loaded here -->
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>

    <script>
        // Production Configuration
        const CONFIG = {
            supabaseUrl: "https://ytoidmelmialrjfqyhet.supabase.co",
            supabaseAnonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0b2lkbWVsbWlhbHJqZnF5aGV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2ODcwNjI1NDIsImV4cCI6MjAwMjYzODU0Mn0.DEMO_KEY_REPLACE_WITH_REAL",
            brandName: "TechAssess Pro",
            brandLogo: "TA"
        };

        // Global State
        const state = {
            currentScreen: 'welcome',
            currentUser: null,
            currentQuestion: 0,
            questions: [],
            answers: [],
            cheatingLogs: [],
            mediaRecorder: null,
            videoChunks: [],
            editors: {},
            timer: null,
            timeLeft: 0,
            supabaseClient: null,
            assessmentDuration: 60
        };

        // Initialize Supabase
        let supabaseClient = null;
        if (typeof supabase !== 'undefined' && CONFIG.supabaseUrl && CONFIG.supabaseAnonKey) {
            try {
                supabaseClient = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseAnonKey);
                state.supabaseClient = supabaseClient;
                console.log('✅ Supabase initialized successfully');
            } catch (error) {
                console.error('❌ Failed to initialize Supabase:', error);
            }
        }

        // Toast Notification System
        function showToast(title, message, type = 'success', duration = 5000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            toast.innerHTML = `
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${title}</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">${message}</div>
                </div>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-secondary);">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(toast);

            if (duration > 0) {
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, duration);
            }
        }

        // Screen Management
        function showScreen(screenName) {
            state.currentScreen = screenName;
            const app = document.getElementById('app');
            
            switch (screenName) {
                case 'welcome':
                    app.innerHTML = renderWelcomeScreen();
                    break;
                case 'instructions':
                    app.innerHTML = renderInstructionsScreen();
                    break;
                case 'assessment':
                    app.innerHTML = renderAssessmentScreen();
                    initializeAssessment();
                    break;
                case 'success':
                    app.innerHTML = renderSuccessScreen();
                    break;
            }
        }

        // Get assessment from URL parameters
        function getAssessmentFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const assessmentId = urlParams.get('assessment');
            const inviteToken = urlParams.get('token');
            
            if (assessmentId && inviteToken) {
                return loadAssessmentById(assessmentId);
            }
            
            // Default assessment for demo/development
            return {
                id: 'default',
                title: 'JavaScript Assessment',
                description: 'Test your programming skills',
                duration: 60,
                language: 'JavaScript',
                difficulty: 'Mixed',
                questions: [
                    {
                        id: 1,
                        title: "Array Sum",
                        description: "Write a function that takes an array of integers and returns the sum of all even numbers.",
                        language: "javascript",
                        starter: "function sumEvenNumbers(arr) {\n    // Your code here\n    \n}",
                        testCases: [
                            { input: "[1, 2, 3, 4, 5, 6]", expected: "12" },
                            { input: "[2, 4, 6, 8]", expected: "20" }
                        ]
                    },
                    {
                        id: 2,
                        title: "String Reversal",
                        description: "Create a function that reverses words in a sentence.",
                        language: "javascript",
                        starter: "function reverseWords(sentence) {\n    // Your code here\n    \n}",
                        testCases: [
                            { input: "'hello world'", expected: "'olleh dlrow'" }
                        ]
                    },
                    {
                        id: 3,
                        title: "Algorithm Challenge",
                        description: "Find the longest palindromic substring.",
                        language: "javascript",
                        starter: "function longestPalindrome(s) {\n    // Your code here\n    \n}",
                        testCases: [
                            { input: "'babad'", expected: "'bab' or 'aba'" }
                        ]
                    }
                ]
            };
        }

        function loadAssessmentById(assessmentId) {
            // This would load from your database in production
            return getAssessmentFromURL();
        }

        // Screen Renderers
        function renderWelcomeScreen() {
            const assessmentInfo = getAssessmentFromURL();
            
            return `
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <div class="brand-header">
                                <div class="brand-logo">${CONFIG.brandLogo}</div>
                                <div>
                                    <h1>${assessmentInfo.title}</h1>
                                    <p>${assessmentInfo.description}</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="info-box">
                                <h3 style="margin-bottom: 12px; font-size: 16px; font-weight: 600;"><i class="fas fa-info-circle"></i> Assessment Details</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; font-size: 14px;">
                                    <div><strong>Duration:</strong> ${assessmentInfo.duration} minutes</div>
                                    <div><strong>Questions:</strong> ${assessmentInfo.questions.length}</div>
                                    <div><strong>Language:</strong> ${assessmentInfo.language}</div>
                                    <div><strong>Difficulty:</strong> ${assessmentInfo.difficulty}</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" id="candidateName" class="form-input" placeholder="Enter your full name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input type="email" id="candidateEmail" class="form-input" placeholder="Enter your email address" required>
                            </div>
                            
                            <div class="warning-box">
                                <h3><i class="fas fa-exclamation-triangle"></i> Before You Begin</h3>
                                <ul style="margin: 12px 0 0 20px; font-size: 14px; line-height: 1.6;">
                                    <li>Ensure you have a stable internet connection</li>
                                    <li>Your webcam will be active throughout the assessment</li>
                                    <li>Do not switch tabs or windows during the assessment</li>
                                    <li>The assessment will auto-submit when time expires</li>
                                </ul>
                            </div>
                            
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="proceedToInstructions()">
                                    <i class="fas fa-arrow-right"></i> Continue
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderInstructionsScreen() {
            const assessmentInfo = getAssessmentFromURL();
            
            return `
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <div class="brand-header">
                                <div class="brand-logo">${CONFIG.brandLogo}</div>
                                <div>
                                    <h1>Assessment Instructions</h1>
                                    <p>Please read carefully before starting</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="warning-box">
                                <h3><i class="fas fa-video"></i> Proctored Assessment</h3>
                                <p>This assessment is monitored. Your webcam will record throughout the session, and all activities are logged for security purposes.</p>
                            </div>
                            
                            <div class="instructions-grid">
                                <div class="instruction-item">
                                    <h3><i class="fas fa-clock"></i> Time Management</h3>
                                    <p>You have <strong>${assessmentInfo.duration} minutes</strong> to complete all questions. The assessment will auto-submit when time expires.</p>
                                </div>
                                
                                <div class="instruction-item">
                                    <h3><i class="fas fa-shield-alt"></i> Security Rules</h3>
                                    <p>Do not switch tabs, open other applications, or leave the assessment window. All activities are monitored.</p>
                                </div>
                                
                                <div class="instruction-item">
                                    <h3><i class="fas fa-code"></i> Coding Guidelines</h3>
                                    <p>Write clean, well-commented code. Test your solutions with the provided examples.</p>
                                </div>
                                
                                <div class="instruction-item">
                                    <h3><i class="fas fa-save"></i> Auto-Save</h3>
                                    <p>Your progress is automatically saved. You can navigate between questions safely.</p>
                                </div>
                            </div>
                            
                            <div class="info-box">
                                <h3 style="margin-bottom: 12px; font-size: 16px; font-weight: 600;">Assessment Overview</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; font-size: 14px;">
                                    <div><strong>Assessment:</strong> ${assessmentInfo.title}</div>
                                    <div><strong>Questions:</strong> ${assessmentInfo.questions.length}</div>
                                    <div><strong>Language:</strong> ${assessmentInfo.language}</div>
                                    <div><strong>Duration:</strong> ${assessmentInfo.duration} minutes</div>
                                </div>
                            </div>
                            
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="showScreen('welcome')">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                                <button class="btn btn-success" onclick="startAssessment()">
                                    <i class="fas fa-play"></i> Start Assessment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAssessmentScreen() {
            return `
                <div class="assessment-container">
                    <div class="assessment-header">
                        <div class="assessment-info">
                            <h2>${state.currentUser.name}</h2>
                            <p>Question ${state.currentQuestion + 1} of ${state.questions.length}</p>
                        </div>
                        <div class="assessment-controls">
                            <div id="timer" class="timer">
                                <i class="fas fa-clock"></i> <span id="timeDisplay">00:00</span>
                            </div>
                            <div class="recording-indicator">
                                <div class="recording-dot"></div>
                                Recording
                            </div>
                        </div>
                    </div>
                    
                    <div class="assessment-content">
                        <div class="questions-panel">
                            <div class="question-nav">
                                ${state.questions.map((_, index) => `
                                    <div class="question-nav-item ${index === state.currentQuestion ? 'active' : ''} ${state.answers[index] && state.answers[index].trim() ? 'answered' : ''}" 
                                         onclick="switchQuestion(${index})">
                                        ${index + 1}
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="current-question">
                                <h3>${state.questions[state.currentQuestion].title}</h3>
                                <p>${state.questions[state.currentQuestion].description}</p>
                                
                                ${state.questions[state.currentQuestion].testCases ? `
                                    <div class="test-cases">
                                        <strong style="font-size: 14px; font-weight: 600; margin-bottom: 12px; display: block;">Test Cases:</strong>
                                        ${state.questions[state.currentQuestion].testCases.map((test, i) => `
                                            <div class="test-case">
                                                <div><strong>Input:</strong> ${test.input}</div>
                                                <div><strong>Expected:</strong> ${test.expected}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="editor-panel">
                            <div class="editor-header">
                                <div class="editor-tab">Solution</div>
                                <div>
                                    <button class="btn btn-secondary" onclick="resetCode()" style="padding: 8px 16px; font-size: 14px;">
                                        <i class="fas fa-undo"></i> Reset
                                    </button>
                                </div>
                            </div>
                            
                            <div id="codeEditor"></div>
                            
                            <div class="status-bar">
                                <div>
                                    <span>Language: ${state.questions[state.currentQuestion].language}</span>
                                    <span style="margin-left: 16px; color: var(--success);">Auto-saved</span>
                                </div>
                                <div>
                                    <button class="btn btn-primary" onclick="submitAssessment()" style="padding: 12px 20px; font-size: 14px;">
                                        <i class="fas fa-paper-plane"></i> Submit Assessment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSuccessScreen() {
            return `
                <div class="container">
                    <div class="card">
                        <div class="card-body success-screen">
                            <div class="success-icon">
                                <i class="fas fa-check"></i>
                            </div>
                            <h1 style="font-size: 32px; font-weight: 700; margin-bottom: 16px;">Assessment Submitted Successfully!</h1>
                            <p style="color: var(--text-secondary); margin-bottom: 32px; font-size: 18px;">
                                Thank you for completing the assessment. Your responses have been recorded and will be reviewed by our team.
                            </p>
                            <div class="info-box">
                                <h3 style="margin-bottom: 16px; font-size: 16px; font-weight: 600;">Submission Details</h3>
                                <div style="font-size: 14px; text-align: left;">
                                    <p><strong>Candidate:</strong> ${state.currentUser?.name}</p>
                                    <p><strong>Questions Completed:</strong> ${state.answers.filter(a => a && a.trim()).length} of ${state.questions.length}</p>
                                    <p><strong>Submitted At:</strong> ${new Date().toLocaleString()}</p>
                                </div>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 14px; margin-top: 24px;">
                                You may now close this window. Results will be communicated separately.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Event Handlers
        function proceedToInstructions() {
            const name = document.getElementById('candidateName').value.trim();
            const email = document.getElementById('candidateEmail').value.trim();
            
            if (!name || !email) {
                showToast('Required Fields', 'Please fill in all required fields.', 'error');
                return;
            }
            
            if (!isValidEmail(email)) {
                showToast('Invalid Email', 'Please enter a valid email address.', 'error');
                return;
            }
            
            state.currentUser = { name, email };
            showToast('Information Saved', 'Proceeding to assessment instructions...', 'success', 2000);
            setTimeout(() => showScreen('instructions'), 1000);
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        async function startAssessment() {
            try {
                showToast('Initializing', 'Setting up your assessment environment...', 'info', 3000);
                
                const assessmentInfo = getAssessmentFromURL();
                if (!assessmentInfo) {
                    showToast('Error', 'Assessment not found.', 'error');
                    return;
                }
                
                state.questions = assessmentInfo.questions;
                state.answers = new Array(state.questions.length).fill('');
                state.currentQuestion = 0;
                state.assessmentDuration = assessmentInfo.duration;
                
                await setupWebcam();
                setupCheatingDetection();
                startTimer(assessmentInfo.duration * 60);
                
                showScreen('assessment');
                showToast('Assessment Started', `You have ${assessmentInfo.duration} minutes to complete all questions.`, 'success', 4000);
                
            } catch (error) {
                console.error('Failed to start assessment:', error);
                showToast('Setup Failed', 'Failed to start assessment. Please check your webcam permissions and try again.', 'error');
            }
        }

        function initializeAssessment() {
            const editorElement = document.getElementById('codeEditor');
            if (editorElement) {
                const editor = CodeMirror(editorElement, {
                    value: state.questions[state.currentQuestion].starter || '',
                    mode: state.questions[state.currentQuestion].language === 'python' ? 'python' : 'javascript',
                    theme: 'github',
                    lineNumbers: true,
                    lineWrapping: true,
                    autoCloseBrackets: true,
                    matchBrackets: true,
                    indentUnit: 4,
                    tabSize: 4
                });
                
                state.editors[state.currentQuestion] = editor;
                
                editor.on('change', () => {
                    state.answers[state.currentQuestion] = editor.getValue();
                    updateQuestionNavigation();
                });
                
                if (state.answers[state.currentQuestion]) {
                    editor.setValue(state.answers[state.currentQuestion]);
                }
            }
        }

        function switchQuestion(questionIndex) {
            if (questionIndex === state.currentQuestion) return;
            
            if (state.editors[state.currentQuestion]) {
                state.answers[state.currentQuestion] = state.editors[state.currentQuestion].getValue();
            }
            
            state.currentQuestion = questionIndex;
            showScreen('assessment');
            showToast('Question Changed', `Switched to question ${questionIndex + 1}`, 'info', 2000);
        }

        function resetCode() {
            if (confirm('Are you sure you want to reset your code for this question?')) {
                const editor = state.editors[state.currentQuestion];
                if (editor) {
                    editor.setValue(state.questions[state.currentQuestion].starter || '');
                    state.answers[state.currentQuestion] = '';
                    updateQuestionNavigation();
                    showToast('Code Reset', 'Your code has been reset to the starter template.', 'warning', 3000);
                }
            }
        }

        function updateQuestionNavigation() {
            const navItems = document.querySelectorAll('.question-nav-item');
            navItems.forEach((item, index) => {
                item.className = 'question-nav-item';
                if (index === state.currentQuestion) {
                    item.classList.add('active');
                }
                if (state.answers[index] && state.answers[index].trim()) {
                    item.classList.add('answered');
                }
            });
        }

        async function submitAssessment() {
            if (!confirm('Are you sure you want to submit your assessment? This action cannot be undone.')) {
                return;
            }
            
            try {
                showToast('Submitting', 'Processing your submission...', 'info');
                
                if (state.editors[state.currentQuestion]) {
                    state.answers[state.currentQuestion] = state.editors[state.currentQuestion].getValue();
                }
                
                if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                    state.mediaRecorder.stop();
                }
                
                if (state.timer) {
                    clearInterval(state.timer);
                }
                
                const submissionData = {
                    candidate_name: state.currentUser.name,
                    candidate_email: state.currentUser.email,
                    questions: state.questions.map(q => ({
                        id: q.id,
                        title: q.title,
                        description: q.description
                    })),
                    answers: state.answers,
                    cheating_logs: state.cheatingLogs,
                    submitted_at: new Date().toISOString(),
                    time_taken: calculateTimeTaken(),
                    duration_allocated: state.assessmentDuration
                };
                
                if (state.supabaseClient) {
                    try {
                        const { data: submission, error } = await state.supabaseClient
                            .from('submissions')
                            .insert(submissionData)
                            .select()
                            .single();
                        
                        if (error) {
                            throw error;
                        }
                        
                        console.log('✅ Submission saved successfully:', submission.id);
                        
                    } catch (dbError) {
                        console.error('❌ Database submission error:', dbError);
                        localStorage.setItem('assessment_backup', JSON.stringify(submissionData));
                        showToast('Submission Warning', 'Your answers were saved locally. Please contact support.', 'warning');
                    }
                } else {
                    localStorage.setItem('assessment_backup', JSON.stringify(submissionData));
                    showToast('Offline Mode', 'Your answers have been saved locally.', 'warning');
                }
                
                showScreen('success');
                showToast('Success', 'Your assessment has been submitted successfully!', 'success', 0);
                
            } catch (error) {
                console.error('Failed to submit assessment:', error);
                showToast('Submission Failed', 'Failed to submit assessment. Please try again.', 'error');
            }
        }

        // Utility Functions
        function startTimer(seconds) {
            state.timeLeft = seconds;
            updateTimerDisplay();
            
            state.timer = setInterval(() => {
                state.timeLeft--;
                updateTimerDisplay();
                
                if (state.timeLeft <= 0) {
                    clearInterval(state.timer);
                    showToast('Time Up', 'Time has expired. Submitting your assessment automatically.', 'warning', 0);
                    setTimeout(() => submitAssessment(), 2000);
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const hours = Math.floor(state.timeLeft / 3600);
            const minutes = Math.floor((state.timeLeft % 3600) / 60);
            const seconds = state.timeLeft % 60;
            
            const display = hours > 0 
                ? `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
                : `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const timerElement = document.getElementById('timeDisplay');
            const timerContainer = document.getElementById('timer');
            if (timerElement && timerContainer) {
                timerElement.textContent = display;
                
                if (state.timeLeft < 300) {
                    timerContainer.className = 'timer danger';
                    if (state.timeLeft % 60 === 0 && state.timeLeft > 0) {
                        showToast('Time Warning', `Only ${Math.floor(state.timeLeft / 60)} minute(s) remaining!`, 'warning', 3000);
                    }
                } else if (state.timeLeft < 600) {
                    timerContainer.className = 'timer warning';
                }
            }
        }

        function calculateTimeTaken() {
            const totalAllocated = (state.assessmentDuration || 60) * 60;
            return totalAllocated - state.timeLeft;
        }

        async function setupWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    }, 
                    audio: true 
                });
                
                state.videoChunks = [];
                state.mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp8,opus'
                });
                
                state.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        state.videoChunks.push(event.data);
                    }
                };
                
                state.mediaRecorder.onstop = async () => {
                    const blob = new Blob(state.videoChunks, { type: 'video/webm' });
                    
                    if (state.supabaseClient) {
                        const fileName = `recording-${Date.now()}-${state.currentUser.name.replace(/\s+/g, '-').toLowerCase()}.webm`;
                        
                        try {
                            const { data, error } = await state.supabaseClient.storage
                                .from('recordings')
                                .upload(fileName, blob, {
                                    contentType: 'video/webm'
                                });
                            
                            if (!error) {
                                console.log('✅ Video uploaded successfully:', fileName);
                            } else {
                                console.error('❌ Video upload failed:', error);
                            }
                        } catch (err) {
                            console.error('❌ Video upload error:', err);
                        }
                    }
                };
                
                state.mediaRecorder.start(1000);
                
            } catch (error) {
                console.error('Webcam setup failed:', error);
                throw error;
            }
        }

        function setupCheatingDetection() {
            const logCheatingEvent = (event, details = {}) => {
                const log = {
                    event,
                    timestamp: new Date().toISOString(),
                    details
                };
                state.cheatingLogs.push(log);
                
                if (state.currentScreen === 'assessment') {
                    showCheatingWarning(event);
                }
            };
            
            window.addEventListener('blur', () => {
                logCheatingEvent('window_blur');
            });
            
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    logCheatingEvent('tab_hidden');
                }
            });
            
            document.addEventListener('keydown', (e) => {
                const suspiciousKeys = ['F12', 'F5'];
                const suspiciousCombos = [
                    { ctrl: true, shift: true, key: 'I' },
                    { ctrl: true, shift: true, key: 'J' },
                    { ctrl: true, key: 'U' }
                ];
                
                if (suspiciousKeys.includes(e.key)) {
                    e.preventDefault();
                    logCheatingEvent('suspicious_key', { key: e.key });
                }
                
                for (const combo of suspiciousCombos) {
                    if (e.ctrlKey === combo.ctrl && e.shiftKey === combo.shift && e.key === combo.key) {
                        e.preventDefault();
                        logCheatingEvent('suspicious_key_combo', combo);
                        break;
                    }
                }
            });
            
            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                logCheatingEvent('context_menu_attempt');
            });
        }

        function showCheatingWarning(eventType) {
            const warnings = {
                'window_blur': 'You switched away from the assessment window!',
                'tab_hidden': 'You switched to another tab!',
                'context_menu_attempt': 'Right-click is disabled during assessment!',
                'suspicious_key': 'That key combination is not allowed!',
                'suspicious_key_combo': 'Developer tools access is prohibited!'
            };
            
            const message = warnings[eventType] || 'Suspicious activity detected!';
            showToast('Security Alert', message, 'error', 5000);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            showScreen('welcome');
        });

        // Prevent common cheating attempts
        window.addEventListener('beforeunload', (e) => {
            if (state.currentScreen === 'assessment') {
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave? Your progress may be lost.';
                return e.returnValue;
            }
        });
    </script>
</body>
</html>
