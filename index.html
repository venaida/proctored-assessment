showToast('Hardware Not Found', 'No camera or microphone detected. Please check your hardware.', 'error');
                } else {
                    showToast('Permission Error', 'Failed to access camera and microphone. Please try again.', 'error');
                }
                return false;
            }
        }

        // URL Parsing and Assessment Loading
        function getAssessmentFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const assessmentId = urlParams.get('assessment');
            const inviteToken = urlParams.get('token');
            
            if (!assessmentId || !inviteToken) {
                return null;
            }
            
            const assessmentData = loadAssessmentById(assessmentId);
            if (!assessmentData) {
                return null;
            }
            
            state.invitationToken = inviteToken;
            state.assessmentId = assessmentId;
            
            return assessmentData;
        }

        function loadAssessmentById(assessmentId) {
            const assessments = {
                'js-fundamentals-2024': {
                    id: 'js-fundamentals-2024',
                    title: 'JavaScript Fundamentals Assessment',
                    description: 'Evaluate core JavaScript programming skills',
                    duration: 60,
                    language: 'JavaScript',
                    difficulty: 'Mixed',
                    questions: [
                        {
                            id: 1,
                            title: "Array Manipulation",
                            description: "Write a function that takes an array of integers and returns the sum of all even numbers.",
                            language: "javascript",
                            starter: "function sumEvenNumbers(arr) {\n    // Your code here\n    \n}",
                            testCases: [
                                { input: "[1, 2, 3, 4, 5, 6]", expected: "12" },
                                { input: "[2, 4, 6, 8]", expected: "20" },
                                { input: "[1, 3, 5]", expected: "0" }
                            ]
                        },
                        {
                            id: 2,
                            title: "String Processing",
                            description: "Create a function that reverses words in a sentence while keeping the word order intact.",
                            language: "javascript",
                            starter: "function reverseWords(sentence) {\n    // Your code here\n    \n}",
                            testCases: [
                                { input: "'hello world'", expected: "'olleh dlrow'" },
                                { input: "'javascript is awesome'", expected: "'tpircsavaj si emosewa'" }
                            ]
                        },
                        {
                            id: 3,
                            title: "Algorithm Challenge",
                            description: "Implement a function to find the longest palindromic substring in a given string.",
                            language: "javascript",
                            starter: "function longestPalindrome(s) {\n    // Your code here\n    \n}",
                            testCases: [
                                { input: "'babad'", expected: "'bab' or 'aba'" },
                                { input: "'cbbd'", expected: "'bb'" }
                            ]
                        }
                    ]
                },
                'python-basics-2024': {
                    id: 'python-basics-2024',
                    title: 'Python Programming Assessment',
                    description: 'Test Python programming fundamentals',
                    duration: 45,
                    language: 'Python',
                    difficulty: 'Beginner to Intermediate',
                    questions: [
                        {
                            id: 1,
                            title: "List Comprehensions",
                            description: "Write a function that uses list comprehension to filter and transform a list of numbers. Return squares of even numbers only.",
                            language: "python",
                            starter: "def square_evens(numbers):\n    \"\"\"\n    Return a list of squares of even numbers from the input list.\n    \n    Args:\n        numbers: List of integers\n    \n    Returns:\n        List of squared even numbers\n    \"\"\"\n    # Your code here\n    pass",
                            testCases: [
                                { input: "[1, 2, 3, 4, 5, 6]", expected: "[4, 16, 36]" },
                                { input: "[1, 3, 5]", expected: "[]" },
                                { input: "[]", expected: "[]" }
                            ]
                        },
                        {
                            id: 2,
                            title: "Dictionary Operations",
                            description: "Create a function that counts the frequency of each character in a string and returns a dictionary.",
                            language: "python",
                            starter: "def char_frequency(text):\n    \"\"\"\n    Count frequency of each character in the text.\n    \n    Args:\n        text: String to analyze\n    \n    Returns:\n        Dictionary with character frequencies\n    \"\"\"\n    # Your code here\n    pass",
                            testCases: [
                                { input: "'hello'", expected: "{'h': 1, 'e': 1, 'l': 2, 'o': 1}" },
                                { input: "'aab'", expected: "{'a': 2, 'b': 1}" }
                            ]
                        }
                    ]
                }
            };
            
            return assessments[assessmentId] || null;
        }

        // Screen Management
        function showScreen(screenName) {
            state.currentScreen = screenName;
            const app = document.getElementById('app');
            
            switch (screenName) {
                case 'welcome':
                    app.innerHTML = renderWelcomeScreen();
                    break;
                case 'instructions':
                    app.innerHTML = renderInstructionsScreen();
                    break;
                case 'assessment':
                    app.innerHTML = renderAssessmentScreen();
                    initializeAssessment();
                    break;
                case 'success':
                    app.innerHTML = renderSuccessScreen();
                    break;
            }
        }

        // Screen Renderers
        function renderWelcomeScreen() {
            const assessmentInfo = getAssessmentFromURL();
            
            if (!assessmentInfo) {
                return `
                    <div class="container">
                        <div class="card">
                            <div class="card-header">
                                <div class="brand-header">
                                    <div class="brand-logo">${CONFIG.brandLogo}</div>
                                    <div>
                                        <h1>Invalid Assessment Link</h1>
                                        <p>Assessment access denied</p>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body" style="text-align: center;">
                                <div class="warning-box">
                                    <h3><i class="fas fa-lock"></i> Access Denied</h3>
                                    <p>This assessment requires a valid invitation link. Please check your email for the correct link or contact your administrator.</p>
                                </div>
                                <div style="color: var(--text-secondary); font-size: 13px; margin-top: 20px;">
                                    <p><strong>Need help?</strong></p>
                                    <ul style="text-align: left; margin: 12px 0; padding-left: 20px;">
                                        <li>Check your email for the assessment invitation</li>
                                        <li>Ensure you're using the complete link provided</li>
                                        <li>Contact your administrator if the issue persists</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <div class="brand-header">
                                <div class="brand-logo">${CONFIG.brandLogo}</div>
                                <div>
                                    <h1>${assessmentInfo.title}</h1>
                                    <p>${assessmentInfo.description}</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="info-box">
                                <h3 style="margin-bottom: 12px; font-size: 14px; font-weight: 600;"><i class="fas fa-info-circle"></i> Assessment Details</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; font-size: 13px;">
                                    <div><strong>Duration:</strong> ${assessmentInfo.duration} minutes</div>
                                    <div><strong>Questions:</strong> ${assessmentInfo.questions.length}</div>
                                    <div><strong>Language:</strong> ${assessmentInfo.language}</div>
                                    <div><strong>Difficulty:</strong> ${assessmentInfo.difficulty}</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" id="candidateName" class="form-input" placeholder="Enter your full name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input type="email" id="candidateEmail" class="form-input" placeholder="Enter your email address" required>
                            </div>
                            
                            <div class="warning-box">
                                <h3><i class="fas fa-exclamation-triangle"></i> Before You Begin</h3>
                                <ul style="margin: 8px 0 0 20px; font-size: 13px;">
                                    <li>Ensure you have a stable internet connection</li>
                                    <li>Your webcam will be active throughout the assessment</li>
                                    <li>Do not switch tabs or windows during the assessment</li>
                                    <li>The assessment will auto-submit when time expires</li>
                                </ul>
                            </div>
                            
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="proceedToInstructions()">
                                    <i class="fas fa-arrow-right"></i> Continue
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderInstructionsScreen() {
            const assessmentInfo = getAssessmentFromURL();
            
            return `
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <div class="brand-header">
                                <div class="brand-logo">${CONFIG.brandLogo}</div>
                                <div>
                                    <h1>Assessment Instructions</h1>
                                    <p>Please read carefully before starting</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="warning-box">
                                <h3><i class="fas fa-video"></i> Proctored Assessment</h3>
                                <p>This assessment is monitored. Your webcam will record throughout the session, and all activities are logged for security purposes.</p>
                            </div>
                            
                            <div class="instructions-grid">
                                <div class="instruction-item">
                                    <h3><i class="fas fa-clock"></i> Time Management</h3>
                                    <p>You have <strong>${assessmentInfo.duration} minutes</strong> to complete all questions. The assessment will auto-submit when time expires.</p>
                                </div>
                                
                                <div class="instruction-item">
                                    <h3><i class="fas fa-shield-alt"></i> Security Rules</h3>
                                    <p>Do not switch tabs, open other applications, or leave the assessment window. All activities are monitored.</p>
                                </div>
                                
                                <div class="instruction-item">
                                    <h3><i class="fas fa-code"></i> Coding Guidelines</h3>
                                    <p>Write clean, well-commented code. Test your solutions with the provided examples.</p>
                                </div>
                                
                                <div class="instruction-item">
                                    <h3><i class="fas fa-save"></i> Auto-Save</h3>
                                    <p>Your progress is automatically saved. You can navigate between questions safely.</p>
                                </div>
                            </div>
                            
                            <div class="info-box">
                                <h3 style="margin-bottom: 12px; font-size: 14px; font-weight: 600;">Assessment Overview</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; font-size: 13px;">
                                    <div><strong>Assessment:</strong> ${assessmentInfo.title}</div>
                                    <div><strong>Questions:</strong> ${assessmentInfo.questions.length}</div>
                                    <div><strong>Language:</strong> ${assessmentInfo.language}</div>
                                    <div><strong>Duration:</strong> ${assessmentInfo.duration} minutes</div>
                                </div>
                            </div>
                            
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="showScreen('welcome')">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                                <button class="btn btn-success" onclick="startAssessment()">
                                    <i class="fas fa-play"></i> Start Assessment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAssessmentScreen() {
            return `
                <div class="assessment-container">
                    <div class="assessment-header">
                        <div class="assessment-info">
                            <h2>${state.currentUser.name}</h2>
                            <p>Question ${state.currentQuestion + 1} of ${state.questions.length}</p>
                        </div>
                        <div class="assessment-controls">
                            <div id="timer" class="timer">
                                <i class="fas fa-clock"></i> <span id="timeDisplay">00:00</span>
                            </div>
                            <div class="recording-indicator">
                                <div class="recording-dot"></div>
                                Recording
                            </div>
                        </div>
                    </div>
                    
                    <div class="assessment-content">
                        <div class="questions-panel">
                            <div class="question-nav">
                                ${state.questions.map((_, index) => `
                                    <div class="question-nav-item ${index === state.currentQuestion ? 'active' : ''} ${state.answers[index] ? 'answered' : ''}" 
                                         onclick="switchQuestion(${index})">
                                        ${index + 1}
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="current-question">
                                <h3>${state.questions[state.currentQuestion].title}</h3>
                                <p>${state.questions[state.currentQuestion].description}</p>
                                
                                ${state.questions[state.currentQuestion].testCases ? `
                                    <div class="test-cases">
                                        <strong style="font-size: 13px; font-weight: 600; margin-bottom: 8px; display: block;">Test Cases:</strong>
                                        ${state.questions[state.currentQuestion].testCases.map((test, i) => `
                                            <div class="test-case">
                                                <div><strong>Input:</strong> ${test.input}</div>
                                                <div><strong>Expected:</strong> ${test.expected}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="editor-panel">
                            <div class="editor-header">
                                <div class="editor-tab">Solution</div>
                                <div>
                                    <button class="btn btn-secondary" onclick="resetCode()" style="padding: 8px 16px; font-size: 13px;">
                                        <i class="fas fa-undo"></i> Reset
                                    </button>
                                </div>
                            </div>
                            
                            <div id="codeEditor"></div>
                            
                            <div class="status-bar">
                                <div>
                                    <span>Language: ${state.questions[state.currentQuestion].language}</span>
                                    <span style="margin-left: 16px; color: var(--success);">Auto-saved</span>
                                </div>
                                <div>
                                    <button class="btn btn-primary" onclick="submitAssessment()" style="padding: 8px 16px; font-size: 13px;">
                                        <i class="fas fa-paper-plane"></i> Submit Assessment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSuccessScreen() {
            return `
                <div class="container">
                    <div class="card">
                        <div class="card-body success-screen">
                            <div class="success-icon">
                                <i class="fas fa-check"></i>
                            </div>
                            <h1 style="font-size: 24px; font-weight: 600; margin-bottom: 12px;">Assessment Submitted Successfully!</h1>
                            <p style="color: var(--text-secondary); margin-bottom: 24px;">
                                Thank you for completing the assessment. Your responses have been recorded and will be reviewed by our team.
                            </p>
                            <div class="info-box">
                                <h3 style="margin-bottom: 12px; font-size: 14px; font-weight: 600;">Submission Details</h3>
                                <div style="font-size: 13px;">
                                    <p><strong>Candidate:</strong> ${state.currentUser?.name}</p>
                                    <p><strong>Questions Completed:</strong> ${state.answers.filter(a => a && a.trim()).length} of ${state.questions.length}</p>
                                    <p><strong>Submitted At:</strong> ${new Date().toLocaleString()}</p>
                                </div>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 13px; margin-top: 20px;">
                                You may now close this window. Results will be communicated separately.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Event Handlers
        async function proceedToInstructions() {
            const name = document.getElementById('candidateName').value.trim();
            const email = document.getElementById('candidateEmail').value.trim();
            
            if (!name || !email) {
                showToast('Required Fields', 'Please fill in all required fields.', 'error');
                return;
            }
            
            if (!isValidEmail(email)) {
                showToast('Invalid Email', 'Please enter a valid email address.', 'error');
                return;
            }
            
            state.currentUser = { name, email };
            
            // Check permissions before proceeding
            const hasPermissions = await checkPermissions();
            if (!hasPermissions) {
                showPermissionModal();
                return;
            }
            
            showToast('Information Saved', 'Proceeding to assessment instructions...', 'success', 2000);
            setTimeout(() => showScreen('instructions'), 1000);
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        async function startAssessment() {
            if (!state.permissionsGranted) {
                const hasPermissions = await checkPermissions();
                if (!hasPermissions) {
                    showPermissionModal();
                    return;
                }
            }

            try {
                showLoading(true);
                showToast('Initializing', 'Setting up your assessment environment...', 'info', 3000);
                
                const assessmentInfo = getAssessmentFromURL();
                if (!assessmentInfo) {
                    showToast('Error', 'Invalid assessment. Please check your invitation link.', 'error');
                    return;
                }
                
                state.questions = assessmentInfo.questions;
                state.answers = new Array(state.questions.length).fill('');
                state.currentQuestion = 0;
                state.assessmentDuration = assessmentInfo.duration;
                
                await setupWebcam();
                setupCheatingDetection();
                startTimer(assessmentInfo.duration * 60);
                
                showScreen('assessment');
                showToast('Assessment Started', `You have ${assessmentInfo.duration} minutes to complete all questions.`, 'success', 4000);
                
            } catch (error) {
                console.error('Failed to start assessment:', error);
                showToast('Setup Failed', 'Failed to start assessment. Please check your webcam permissions and try again.', 'error');
            } finally {
                showLoading(false);
            }
        }

        function initializeAssessment() {
            const editorElement = document.getElementById('codeEditor');
            if (editorElement) {
                const editor = CodeMirror(editorElement, {
                    value: state.questions[state.currentQuestion].starter || '',
                    mode: state.questions[state.currentQuestion].language === 'python' ? 'python' : 'javascript',
                    theme: 'github',
                    lineNumbers: true,
                    lineWrapping: true,
                    autoCloseBrackets: true,
                    matchBrackets: true,
                    indentUnit: 4,
                    tabSize: 4,
                    extraKeys: {
                        "Tab": function(cm) {
                            cm.replaceSelection("    ");
                        }
                    }
                });
                
                state.editors[state.currentQuestion] = editor;
                
                editor.on('change', () => {
                    state.answers[state.currentQuestion] = editor.getValue();
                    updateQuestionNavigation();
                });
                
                if (state.answers[state.currentQuestion]) {
                    editor.setValue(state.answers[state.currentQuestion]);
                }
            }
        }

        function switchQuestion(questionIndex) {
            if (questionIndex === state.currentQuestion) return;
            
            if (state.editors[state.currentQuestion]) {
                state.answers[state.currentQuestion] = state.editors[state.currentQuestion].getValue();
            }
            
            state.currentQuestion = questionIndex;
            showScreen('assessment');
            showToast('Question Changed', `Switched to question ${questionIndex + 1}`, 'info', 2000);
        }

        function resetCode() {
            if (confirm('Are you sure you want to reset your code for this question?')) {
                const editor = state.editors[state.currentQuestion];
                if (editor) {
                    editor.setValue(state.questions[state.currentQuestion].starter || '');
                    state.answers[state.currentQuestion] = '';
                    updateQuestionNavigation();
                    showToast('Code Reset', 'Your code has been reset to the starter template.', 'warning', 3000);
                }
            }
        }

        function updateQuestionNavigation() {
            const navItems = document.querySelectorAll('.question-nav-item');
            navItems.forEach((item, index) => {
                item.classList.remove('active', 'answered');
                if (index === state.currentQuestion) {
                    item.classList.add('active');
                }
                if (state.answers[index] && state.answers[index].trim()) {
                    item.classList.add('answered');
                }
            });
        }

        async function submitAssessment() {
            if (!confirm('Are you sure you want to submit your assessment? This action cannot be undone.')) {
                return;
            }
            
            try {
                showLoading(true);
                showToast('Submitting', 'Processing your submission...', 'info');
                
                if (state.editors[state.currentQuestion]) {
                    state.answers[state.currentQuestion] = state.editors[state.currentQuestion].getValue();
                }
                
                if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                    state.mediaRecorder.stop();
                }
                
                if (state.timer) {
                    clearInterval(state.timer);
                }
                
                const submissionData = {
                    candidate_name: state.currentUser.name,
                    candidate_email: state.currentUser.email,
                    assessment_id: state.assessmentId,
                    invitation_token: state.invitationToken,
                    questions: state.questions,
                    answers: state.answers,
                    cheating_logs: state.cheatingLogs,
                    submitted_at: new Date().toISOString(),
                    time_taken: calculateTimeTaken(),
                    duration_allocated: state.assessmentDuration
                };
                
                if (state.supabaseClient) {
                    const { data, error } = await state.supabaseClient
                        .from('submissions')
                        .insert(submissionData);
                    
                    if (error) {
                        console.error('Submission error:', error);
                        showToast('Submission Error', 'Failed to submit. Please try again.', 'error');
                        return;
                    }
                }
                
                logSecurityEvent('assessment_submitted');
                showScreen('success');
                showToast('Success', 'Your assessment has been submitted successfully!', 'success', 0);
                
            } catch (error) {
                console.error('Failed to submit assessment:', error);
                showToast('Submission Failed', 'Failed to submit assessment. Please try again.', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Utility Functions
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.toggle('hidden', !show);
        }

        function startTimer(seconds) {
            state.timeLeft = seconds;
            updateTimerDisplay();
            
            state.timer = setInterval(() => {
                state.timeLeft--;
                updateTimerDisplay();
                
                if (state.timeLeft <= 0) {
                    clearInterval(state.timer);
                    showToast('Time Up', 'Time has expired. Submitting your assessment automatically.', 'warning', 0);
                    setTimeout(() => submitAssessment(), 2000);
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const hours = Math.floor(state.timeLeft / 3600);
            const minutes = Math.floor((state.timeLeft % 3600) / 60);
            const seconds = state.timeLeft % 60;
            
            const display = hours > 0 
                ? `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
                : `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const timerElement = document.getElementById('timeDisplay');
            const timerContainer = document.getElementById('timer');
            if (timerElement && timerContainer) {
                timerElement.textContent = display;
                
                if (state.timeLeft < 300) {
                    timerContainer.className = 'timer danger';
                    if (state.timeLeft % 60 === 0 && state.timeLeft > 0) {
                        showToast('Time Warning', `Only ${Math.floor(state.timeLeft / 60)} minute(s) remaining!`, 'warning', 3000);
                    }
                } else if (state.timeLeft < 600) {
                    timerContainer.className = 'timer warning';
                }
            }
        }

        function calculateTimeTaken() {
            const totalAllocated = (state.assessmentDuration || 60) * 60;
            return totalAllocated - state.timeLeft;
        }

        async function setupWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    }, 
                    audio: true 
                });
                
                const video = document.getElementById('webcamVideo');
                if (video) {
                    video.srcObject = stream;
                    document.getElementById('webcamPreview').classList.remove('hidden');
                }
                
                state.videoChunks = [];
                state.mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp8,opus'
                });
                
                state.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        state.videoChunks.push(event.data);
                    }
                };
                
                state.mediaRecorder.onstop = async () => {
                    const blob = new Blob(state.videoChunks, { type: 'video/webm' });
                    
                    if (state.supabaseClient) {
                        const fileName = `recording-${Date.now()}-${state.currentUser.name.replace(/\s+/g, '-')}.webm`;
                        
                        try {
                            const { data, error } = await state.supabaseClient.storage
                                .from('recordings')
                                .upload(fileName, blob);
                            
                            if (!error) {
                                console.log('Video uploaded successfully:', fileName);
                            }
                        } catch (err) {
                            console.error('Video upload failed:', err);
                        }
                    }
                };
                
                state.mediaRecorder.start(1000);
                
            } catch (error) {
                console.error('Webcam setup failed:', error);
                throw error;
            }
        }

        function setupCheatingDetection() {
            const logCheatingEvent = (event, details = {}) => {
                const log = {
                    event,
                    timestamp: new Date().toISOString(),
                    details
                };
                state.cheatingLogs.push(log);
                logSecurityEvent(event, details);
                
                if (state.currentScreen === 'assessment') {
                    showCheatingWarning(event);
                }
            };
            
            window.addEventListener('blur', () => {
                logCheatingEvent('window_blur');
            });
            
            window.addEventListener('focus', () => {
                logCheatingEvent('window_focus');
            });
            
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    logCheatingEvent('tab_hidden');
                } else {
                    logCheatingEvent('tab_visible');
                }
            });
            
            document.addEventListener('keydown', (e) => {
                const suspiciousKeys = ['F12', 'F5', 'PrintScreen'];
                const suspiciousCombos = [
                    { ctrl: true, shift: true, key: 'I' },
                    { ctrl: true, shift: true, key: 'J' },
                    { ctrl: true, shift: true, key: 'C' },
                    { ctrl: true, key: 'U' },
                    { ctrl: true, key: 'R' },
                    { alt: true, key: 'Tab' },
                    { ctrl: true, key: 'Tab' }
                ];
                
                if (suspiciousKeys.includes(e.key)) {
                    e.preventDefault();
                    logCheatingEvent('suspicious_key', { key: e.key });
                }
                
                for (const combo of suspiciousCombos) {
                    if (
                        (combo.ctrl ? e.ctrlKey : true) &&
                        (combo.shift ? e.shiftKey : true) &&
                        (combo.alt ? e.altKey : true) &&
                        e.key === combo.key
                    ) {
                        e.preventDefault();
                        logCheatingEvent('suspicious_key_combo', combo);
                        break;
                    }
                }
            });
            
            document.addEventListener('mouseleave', () => {
                logCheatingEvent('mouse_leave');
            });
            
            document.addEventListener('paste', (e) => {
                if (e.target.closest('.CodeMirror')) {
                    logCheatingEvent('paste_attempt', {
                        content: e.clipboardData.getData('text').substring(0, 100)
                    });
                }
            });
        }

        function showCheatingWarning(eventType) {
            const warnings = {
                'window_blur': 'You switched away from the assessment window!',
                'tab_hidden': 'You switched to another tab!',
                'context_menu_attempt': 'Right-click is disabled during assessment!',
                'suspicious_key': 'That key combination is not allowed!',
                'suspicious_key_combo': 'Developer tools access is prohibited!',
                'mouse_leave': 'Keep your mouse within the assessment window!',
                'paste_attempt': 'Pasting content has been logged!'
            };
            
            const message = warnings[eventType] || 'Suspicious activity detected!';
            showToast('Security Alert', message, 'error', 5000);
        }

        function logSecurityEvent(event, details = {}) {
            console.warn('Security event:', { event, details, timestamp: new Date().toISOString() });
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            showScreen('welcome');
            
            // Auto-check permissions on page load
            setTimeout(async () => {
                const hasPermissions = await checkPermissions();
                if (!hasPermissions) {
                    showToast('Camera Required', 'This assessment requires camera and microphone access. Please grant permissions when prompted.', 'info', 8000);
                }
            }, 2000);
        });

        // Prevent common cheating attempts
        window.addEventListener('beforeunload', (e) => {
            if (state.currentScreen === 'assessment') {
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave? Your progress may be lost.';
                logSecurityEvent('page_unload_attempt');
                return e.returnValue;
            }
        });

        // Security: Additional protection measures
        (function() {
            // Disable drag and drop
            document.addEventListener('dragstart', (e) => e.preventDefault());
            document.addEventListener('drop', (e) => e.preventDefault());
            
            // Disable print screen
            document.addEventListener('keyup', (e) => {
                if (e.key === 'PrintScreen') {
                    logSecurityEvent('screenshot_attempt');
                    showToast('Security Alert', 'Screenshots are not allowed during assessment', 'error');
                }
            });
            
            // Monitor focus changes
            let focusWarnings = 0;
            window.addEventListener('blur', () => {
                if (state.currentScreen === 'assessment') {
                    focusWarnings++;
                    if (focusWarnings >= 3) {
                        showToast('Multiple Warnings', 'Multiple focus changes detected. Assessment may be flagged.', 'error');
                    }
                }
            });
        })();

        // Permission request on user interaction if not granted
        document.addEventListener('click', async () => {
            if (!state.permissionsGranted && state.currentScreen === 'welcome') {
                const hasPermissions = await checkPermissions();
                if (!hasPermissions) {
                    showPermissionModal();
                }
            }
        });

        // Auto-request permissions on certain actions
        const originalProceedToInstructions = proceedToInstructions;
        proceedToInstructions = async function() {
            if (!state.permissionsGranted) {
                const hasPermissions = await checkPermissions();
                if (!hasPermissions) {
                    showPermissionModal();
                    // Store the action to continue after permission is granted
                    window.pendingAction = originalProceedToInstructions;
                    return;
                }
            }
            return originalProceedToInstructions();
        };

        // Continue pending action after permission is granted
        const originalRequestPermissions = requestPermissions;
        requestPermissions = async function() {
            const result = await originalRequestPermissions();
            if (result && window.pendingAction) {
                const action = window.pendingAction;
                window.pendingAction = null;
                setTimeout(action, 500);
            }
            return result;
        };

        // Obfuscation and source protection (production only)
        if (SECURITY_CONFIG.obfuscateCode) {
            Object.defineProperty(window, 'source', {
                get: function() {
                    logSecurityEvent('source_access_attempt');
                    return 'Access denied';
                }
            });
        }

        // Performance monitoring
        window.addEventListener('load', () => {
            const loadTime = performance.now();
            console.log(`Assessment platform loaded in ${loadTime.toFixed(2)}ms`);
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechAssess Pro - Assessment Platform</title>
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com; img-src 'self' data:; media-src 'self' blob:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/github.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Security: Disable text selection and context menu */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Allow text selection only in code editor and input fields */
        .CodeMirror, input, textarea, .code-viewer {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }

        :root {
            --primary: #1a1a1a;
            --primary-hover: #2a2a2a;
            --secondary: #f8f9fa;
            --accent: #e9ecef;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --radius: 4px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 320px;
            max-width: 400px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideInRight 0.3s ease;
        }

        .toast.success { border-left: 4px solid var(--success); }
        .toast.warning { border-left: 4px solid var(--warning); }
        .toast.error { border-left: 4px solid var(--error); }
        .toast.info { border-left: 4px solid var(--primary); }

        .toast-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Main Layout */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            width: 100%;
            box-shadow: var(--shadow);
        }

        .card-header {
            background: var(--secondary);
            border-bottom: 1px solid var(--border);
            padding: 24px;
            text-align: center;
        }

        .brand-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .brand-logo {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
        }

        .card-header h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .card-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .card-body {
            padding: 24px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            background: white;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border: 1px solid transparent;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            min-height: 44px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            border-color: var(--primary-hover);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border-color: var(--border);
        }

        .btn-secondary:hover {
            background: var(--secondary);
        }

        .btn-success {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .btn-success:hover {
            background: #16a34a;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
        }

        /* Permission Request Modal */
        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .permission-content {
            background: white;
            border-radius: var(--radius);
            padding: 32px;
            max-width: 480px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .permission-icon {
            width: 80px;
            height: 80px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 32px;
        }

        /* Assessment Layout */
        .assessment-container {
            max-width: none;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .assessment-header {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .assessment-info h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .assessment-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .assessment-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .timer {
            background: var(--success);
            color: white;
            padding: 8px 16px;
            border-radius: var(--radius);
            font-weight: 600;
            font-family: monospace;
            font-size: 14px;
        }

        .timer.warning { background: var(--warning); }
        .timer.danger { background: var(--error); }

        .recording-indicator {
            background: var(--error);
            color: white;
            padding: 8px 16px;
            border-radius: var(--radius);
            font-weight: 500;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .recording-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .assessment-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .questions-panel {
            width: 320px;
            background: var(--secondary);
            border-right: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .question-nav {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
            margin-bottom: 24px;
        }

        .question-nav-item {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            background: white;
            transition: all 0.2s;
        }

        .question-nav-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .question-nav-item.answered {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .current-question {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }

        .current-question h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .current-question p {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .test-cases {
            margin-top: 16px;
        }

        .test-case {
            background: var(--accent);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 12px;
            margin-bottom: 8px;
            font-family: monospace;
            font-size: 13px;
        }

        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .editor-header {
            padding: 12px 20px;
            background: var(--secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .editor-tab {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
        }

        .CodeMirror {
            height: calc(100vh - 180px) !important;
            font-size: 14px;
            font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
            border: none;
        }

        .status-bar {
            padding: 12px 20px;
            background: var(--secondary);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        /* Webcam */
        .webcam-preview {
            position: fixed;
            bottom: 100px; /* Moved up to avoid submit button */
            right: 20px;
            width: 200px;
            height: 150px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            background: black;
            z-index: 1000;
        }

        .webcam-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Info Boxes */
        .info-box {
            background: var(--accent);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin: 16px 0;
        }

        .warning-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-left: 4px solid #f59e0b;
            border-radius: var(--radius);
            padding: 16px;
            margin: 16px 0;
        }

        .warning-box h3 {
            color: #92400e;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Instructions */
        .instructions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }

        .instruction-item {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
        }

        .instruction-item h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success Screen */
        .success-screen {
            text-align: center;
            padding: 40px 24px;
        }

        .success-icon {
            width: 60px;
            height: 60px;
            background: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 24px;
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px 10px;
            }

            .assessment-content {
                flex-direction: column;
            }

            .questions-panel {
                width: 100%;
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .webcam-preview {
                width: 120px;
                height: 90px;
                bottom: 60px;
                right: 10px;
            }

            .CodeMirror {
                height: calc(100vh - 280px) !important;
            }
        }

        /* Security: Hide scrollbars in developer tools */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: var(--radius);
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Content will be dynamically loaded here -->
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
    </div>

    <!-- Permission Request Modal -->
    <div id="permissionModal" class="permission-modal hidden">
        <div class="permission-content">
            <div class="permission-icon">
                <i class="fas fa-video"></i>
            </div>
            <h2 style="margin-bottom: 16px; font-size: 20px;">Camera & Microphone Access Required</h2>
            <p style="margin-bottom: 24px; color: var(--text-secondary); line-height: 1.6;">
                This assessment requires access to your camera and microphone for proctoring purposes. 
                Please click "Allow" when prompted by your browser.
            </p>
            <div style="background: var(--warning); color: white; padding: 12px; border-radius: var(--radius); margin-bottom: 24px; font-size: 14px;">
                <strong><i class="fas fa-exclamation-triangle"></i> Important:</strong>
                Your camera will record throughout the assessment for security purposes.
            </div>
            <button class="btn btn-primary" onclick="requestPermissions()">
                <i class="fas fa-video"></i> Grant Camera Access
            </button>
        </div>
    </div>

    <!-- Webcam Preview -->
    <div id="webcamPreview" class="webcam-preview hidden">
        <video id="webcamVideo" autoplay muted playsinline></video>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Security Configuration
        const SECURITY_CONFIG = {
            antiDebug: true,
            disableDevTools: true,
            obfuscateCode: true,
            preventInspection: true
        };

        // Application Configuration
        const CONFIG = {
            supabaseUrl: "https://ytoidmelmialrjfqyhet.supabase.co",
            supabaseAnonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0b2lkbWVsbWlhbHJqZnF5aGV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2ODcwNjI1NDIsImV4cCI6MjAwMjYzODU0Mn0.DEMO_KEY_REPLACE_WITH_REAL",
            brandName: "TechAssess Pro",
            brandLogo: "TA", // Will be replaced with actual logo
            companyName: "Your Company Name"
        };

        // Global State
        const state = {
            currentScreen: 'welcome',
            currentUser: null,
            currentQuestion: 0,
            questions: [],
            answers: [],
            cheatingLogs: [],
            mediaRecorder: null,
            videoChunks: [],
            editors: {},
            timer: null,
            timeLeft: 0,
            supabaseClient: null,
            assessmentDuration: 60,
            invitationToken: null,
            assessmentId: null,
            permissionsGranted: false
        };

        // Security: Anti-debugging measures
        (function() {
            if (SECURITY_CONFIG.antiDebug) {
                setInterval(() => {
                    if (window.outerHeight - window.innerHeight > 200 || window.outerWidth - window.innerWidth > 200) {
                        logSecurityEvent('dev_tools_detected');
                        document.body.innerHTML = '<div style="padding: 40px; text-align: center;"><h1>Security Alert</h1><p>Development tools detected. Assessment terminated.</p></div>';
                    }
                }, 1000);

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || 
                        (e.ctrlKey && e.shiftKey && e.key === 'J') || (e.ctrlKey && e.key === 'U')) {
                        e.preventDefault();
                        logSecurityEvent('dev_tools_attempt');
                        showToast('Security Alert', 'Developer tools are disabled during assessment', 'error');
                        return false;
                    }
                });

                document.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    logSecurityEvent('context_menu_attempt');
                    showToast('Warning', 'Right-click is disabled during assessment', 'warning');
                });
            }
        })();

        // Initialize Supabase
        if (typeof supabase !== 'undefined') {
            state.supabaseClient = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseAnonKey);
        }

        // Toast Notification System
        function showToast(title, message, type = 'success', duration = 5000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fas fa-check-circle',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle',
                info: 'fas fa-info-circle'
            };

            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="${icons[type] || icons.info}" style="color: var(--${type})"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(toast);

            if (duration > 0) {
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.style.animation = 'slideOutRight 0.3s ease';
                        setTimeout(() => toast.remove(), 300);
                    }
                }, duration);
            }
        }

        // Permission Management
        async function checkPermissions() {
            try {
                const permissions = await navigator.mediaDevices.enumerateDevices();
                const hasCamera = permissions.some(device => device.kind === 'videoinput');
                const hasMicrophone = permissions.some(device => device.kind === 'audioinput');
                
                if (!hasCamera || !hasMicrophone) {
                    showToast('Hardware Required', 'Camera and microphone are required for this assessment', 'error');
                    return false;
                }

                // Check if permissions are already granted
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    state.permissionsGranted = true;
                    return true;
                } catch (error) {
                    // Permissions not granted, show modal
                    return false;
                }
            } catch (error) {
                console.error('Permission check failed:', error);
                showToast('Permission Error', 'Unable to check camera and microphone permissions', 'error');
                return false;
            }
        }

        function showPermissionModal() {
            document.getElementById('permissionModal').classList.remove('hidden');
        }

        function hidePermissionModal() {
            document.getElementById('permissionModal').classList.add('hidden');
        }

        async function requestPermissions() {
            try {
                showLoading(true);
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    }, 
                    audio: true 
                });
                
                // Test the stream briefly then stop it
                stream.getTracks().forEach(track => track.stop());
                
                state.permissionsGranted = true;
                hidePermissionModal();
                showToast('Permissions Granted', 'Camera and microphone access granted successfully', 'success');
                
                showLoading(false);
                return true;
            } catch (error) {
                showLoading(false);
                console.error('Permission request failed:', error);
                
                if (error.name === 'NotAllowedError') {
                    showToast('Permission Denied', 'Camera and microphone access is required to proceed. Please allow access and try again.', 'error');
                } else if (error.name === 'NotFoundError') {
                    showToast('Hardware Not Found', 'No camera or microphone detected. Please check your hardware.',
