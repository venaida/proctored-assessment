<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechAssess Pro - Assessment Platform</title>
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/github.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a1a1a;
            --primary-hover: #2a2a2a;
            --secondary: #f8f9fa;
            --accent: #e9ecef;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --radius: 8px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow: hidden;
        }

        /* Custom Scrollbar Styling */
        .questions-panel::-webkit-scrollbar, .CodeMirror-vscrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .questions-panel::-webkit-scrollbar-track, .CodeMirror-vscrollbar::-webkit-scrollbar-track {
            background: var(--secondary);
        }
        .questions-panel::-webkit-scrollbar-thumb, .CodeMirror-vscrollbar::-webkit-scrollbar-thumb {
            background-color: var(--accent);
            border-radius: 10px;
            border: 2px solid var(--secondary);
        }
        .questions-panel::-webkit-scrollbar-thumb:hover, .CodeMirror-vscrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #ccc;
        }

        /* Custom Toast & Modal System */
        .custom-toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 12px; }
        .custom-toast { background: white; border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12); min-width: 320px; max-width: 400px; display: flex; align-items: flex-start; gap: 12px; animation: slideInRight 0.3s ease; font-family: inherit; }
        .custom-toast.success { border-left: 4px solid var(--success); }
        .custom-toast.warning { border-left: 4px solid var(--warning); }
        .custom-toast.error { border-left: 4px solid var(--error); }
        .custom-toast.info { border-left: 4px solid var(--primary); }
        .custom-toast-content { flex: 1; }
        .custom-toast-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .custom-toast-message { font-size: 13px; color: var(--text-secondary); }
        .custom-toast-close { background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-secondary); opacity: 0.7; transition: opacity 0.2s; }
        .custom-toast-close:hover { opacity: 1; }
        .confirmation-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 10001; animation: fadeIn 0.2s ease; }
        .confirmation-content { background: white; border-radius: var(--radius); padding: 32px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); animation: scaleIn 0.3s ease; }
        .confirmation-icon { width: 60px; height: 60px; margin: 0 auto 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; }
        .confirmation-icon.warning { background: var(--warning); }
        .confirmation-icon.error { background: var(--error); }
        .confirmation-icon.info { background: var(--primary); }
        .confirmation-title { font-size: 20px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary); }
        .confirmation-message { color: var(--text-secondary); margin-bottom: 24px; line-height: 1.5; }
        .confirmation-buttons { display: flex; gap: 12px; justify-content: center; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Webcam Preview */
        .webcam-preview { position: fixed; bottom: 20px; left: 20px; width: 200px; height: 150px; border: 3px solid var(--primary); border-radius: var(--radius); overflow: hidden; background: black; z-index: 999; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); transition: opacity 0.3s ease; }
        .webcam-preview video { width: 100%; height: 100%; object-fit: cover; }
        .webcam-preview::after { content: "Recording"; position: absolute; top: 8px; left: 8px; background: var(--error); color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; }
        @media (max-width: 768px) { .webcam-preview { width: 120px; height: 90px; bottom: 10px; left: 10px; } }

        /* Main Layout */
        #app { height: 100vh; overflow-y: auto; }
        .container { max-width: 800px; margin: 0 auto; padding: 40px 20px; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .card { background: white; border-radius: var(--radius); overflow: hidden; width: 100%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2); }
        .card-header { background: var(--secondary); padding: 32px; text-align: center; border-bottom: 1px solid var(--border); }
        .brand-header { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 20px; }
        .brand-logo { width: 60px; height: 60px; background: var(--primary); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 24px; }
        .card-header h1 { font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; }
        .card-header p { color: var(--text-secondary); font-size: 16px; }
        .card-body { padding: 32px; }
        .form-group { margin-bottom: 24px; }
        .form-label { display: block; font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 8px; }
        .form-input { width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: var(--radius); font-size: 16px; background: white; transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.1); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 16px 24px; border: none; border-radius: var(--radius); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; min-height: 48px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(26, 26, 26, 0.2); }
        .btn-secondary { background: white; color: var(--text-primary); border: 2px solid var(--border); }
        .btn-secondary:hover { background: var(--secondary); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #16a34a; transform: translateY(-2px); box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3); }
        .btn-group { display: flex; gap: 16px; justify-content: center; margin-top: 32px; }
        .info-box { background: var(--accent); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin: 20px 0; }
        .warning-box { background: #fef3c7; border: 1px solid #f59e0b; border-left: 4px solid #f59e0b; border-radius: var(--radius); padding: 20px; margin: 20px 0; }
        .warning-box h3 { color: #92400e; font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .instructions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin: 24px 0; }
        .instruction-item { background: var(--secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
        .instruction-item h3 { font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }

        /* Assessment Layout */
        .assessment-container { background: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .assessment-header { background: white; border-bottom: 2px solid var(--border); padding: 20px 32px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); flex-shrink: 0; }
        .assessment-info h2 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
        .assessment-info p { font-size: 14px; color: var(--text-secondary); }
        .assessment-controls { display: flex; align-items: center; gap: 20px; }
        .timer { background: var(--success); color: white; padding: 12px 20px; border-radius: 24px; font-weight: 700; font-family: monospace; font-size: 16px; }
        .timer.warning { background: var(--warning); color: var(--text-primary); }
        .timer.danger { background: var(--error); }
        .recording-indicator { background: var(--error); color: white; padding: 12px 20px; border-radius: 24px; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .recording-dot { width: 10px; height: 10px; background: white; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .assessment-content { flex: 1; display: flex; overflow: hidden; }
        .questions-panel { width: 360px; background: var(--secondary); border-right: 2px solid var(--border); padding: 24px; overflow-y: auto; flex-shrink: 0; }
        .question-nav { display: grid; grid-template-columns: repeat(auto-fill, minmax(48px, 1fr)); gap: 12px; margin-bottom: 32px; }
        .question-nav-item { width: 48px; height: 48px; border: 2px solid var(--border); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: 700; font-size: 16px; background: white; transition: all 0.2s; }
        .question-nav-item.active { background: var(--primary); color: white; border-color: var(--primary); }
        .question-nav-item.answered { background: var(--success); color: white; border-color: var(--success); }
        .current-question { background: white; border: 2px solid var(--border); border-radius: var(--radius); padding: 24px; }
        .current-question h3 { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--text-primary); }
        .current-question p { color: var(--text-secondary); line-height: 1.7; margin-bottom: 20px; }
        .test-cases { margin-top: 20px; }
        .test-case { background: var(--accent); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; font-family: 'Monaco', 'Consolas', monospace; font-size: 14px; }
        
        /* FIXED: IDE Layout */
        .editor-panel { flex: 1; display: flex; flex-direction: column; background: white; overflow: hidden; }
        .editor-header { padding: 16px 24px; background: var(--secondary); border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .editor-tab { background: white; border: 2px solid var(--border); border-radius: var(--radius); padding: 8px 16px; font-size: 14px; font-weight: 600; }
        #codeEditor { flex-grow: 1; position: relative; overflow: auto; }
        .CodeMirror { position: absolute; top: 0; left: 0; right: 0; bottom: 0; height: 100%; font-size: 16px; font-family: 'Monaco', 'Consolas', monospace; }
        .status-bar { padding: 16px 24px; background: var(--secondary); border-top: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: var(--text-secondary); flex-shrink: 0; }

        /* Success Screen */
        .success-screen { text-align: center; padding: 48px 32px; }
        .success-icon { width: 80px; height: 80px; background: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; color: white; font-size: 32px; }
        .hidden { display: none !important; }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container { padding: 20px 10px; }
            .assessment-content { flex-direction: column; }
            .questions-panel { width: 100%; max-height: 40vh; border-right: none; border-bottom: 2px solid var(--border); }
            .btn-group { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Content will be dynamically loaded here -->
    </div>

    <div id="customToastContainer" class="custom-toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>

    <script>
        // Production Configuration
        const CONFIG = {
            supabaseUrl: "https://ytoidmelmialrjfqyhet.supabase.co",
            supabaseAnonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0b2lkbWVsbWlhbHJqZnF5aGV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2ODcwNjI1NDIsImV4cCI6MjAwMjYzODU0Mn0.DEMO_KEY_REPLACE_WITH_REAL",
            brandName: "TechAssess Pro",
            brandLogo: "TA"
        };

        const state = {
            currentScreen: 'loading', currentUser: null, currentQuestion: 0, questions: [], answers: [], cheatingLogs: [], mediaRecorder: null, videoChunks: [], webcamStream: null, editors: {}, timer: null, timeLeft: 0, assessmentData: null, isModalOpen: false,
        };

        const supabaseClient = (typeof supabase !== 'undefined' && CONFIG.supabaseUrl && CONFIG.supabaseAnonKey) ? supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseAnonKey) : null;
        if (supabaseClient) console.log('✅ Supabase initialized'); else console.warn('⚠️ Supabase not configured');

        function showCustomToast(title, message, type = 'success', duration = 5000) {
            const container = document.getElementById('customToastContainer');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `custom-toast ${type}`;
            toast.innerHTML = `<div class="custom-toast-content"><div class="custom-toast-title">${title}</div><div class="custom-toast-message">${message}</div></div><button class="custom-toast-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>`;
            container.appendChild(toast);
            if (duration > 0) setTimeout(() => toast.remove(), duration);
        }

        function showCustomConfirm(title, message, type = 'warning') {
            return new Promise((resolve) => {
                state.isModalOpen = true;
                const modal = document.createElement('div');
                modal.className = 'confirmation-modal';
                const iconClass = type === 'error' ? 'fas fa-exclamation-triangle' : type === 'info' ? 'fas fa-info-circle' : 'fas fa-question-circle';
                modal.innerHTML = `<div class="confirmation-content"><div class="confirmation-icon ${type}"><i class="${iconClass}"></i></div><div class="confirmation-title">${title}</div><div class="confirmation-message">${message}</div><div class="confirmation-buttons"><button id="confirmCancel" class="btn btn-secondary">Cancel</button><button id="confirmOk" class="btn btn-primary">Confirm</button></div></div>`;
                document.body.appendChild(modal);
                const close = (result) => { modal.remove(); state.isModalOpen = false; resolve(result); };
                document.getElementById('confirmOk').onclick = () => close(true);
                document.getElementById('confirmCancel').onclick = () => close(false);
            });
        }

        async function setupWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 640 }, height: { ideal: 480 } }, audio: true });
                state.webcamStream = stream;
                const videoPreview = document.getElementById('webcamPreview');
                const videoEl = document.getElementById('webcamVideo');
                if (videoPreview && videoEl) {
                    videoEl.srcObject = stream;
                    videoPreview.classList.remove('hidden');
                }
                state.mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8,opus' });
                state.mediaRecorder.ondataavailable = (event) => event.data.size > 0 && state.videoChunks.push(event.data);
                state.mediaRecorder.start(1000);
            } catch (error) {
                console.error('Webcam setup failed:', error);
                showCustomToast('Camera Error', 'Could not access camera. Assessment will continue without recording.', 'warning');
            }
        }

        function stopWebcam() {
            if (state.mediaRecorder && state.mediaRecorder.state === 'recording') state.mediaRecorder.stop();
            if (state.webcamStream) state.webcamStream.getTracks().forEach(track => track.stop());
            state.webcamStream = null;
            const webcamPreview = document.getElementById('webcamPreview');
            if (webcamPreview) webcamPreview.classList.add('hidden');
        }

        function setupCheatingDetection() {
            const logCheatingEvent = (event, details = {}) => {
                if (state.isModalOpen) return;
                state.cheatingLogs.push({ event, timestamp: new Date().toISOString(), details });
                if (state.currentScreen === 'assessment') showCheatingWarning(event);
            };
            window.addEventListener('blur', () => logCheatingEvent('window_blur'));
            document.addEventListener('visibilitychange', () => document.hidden && logCheatingEvent('tab_hidden'));
            document.addEventListener('mouseleave', () => logCheatingEvent('mouse_left_window'));
            document.addEventListener('contextmenu', (e) => { e.preventDefault(); logCheatingEvent('context_menu_attempt'); });
        }
        function showCheatingWarning(eventType) {
            const warnings = { 'window_blur': 'You switched away from the assessment window!', 'tab_hidden': 'You switched to another tab!', 'mouse_left_window': 'Your cursor left the assessment window!' };
            showCustomToast('Security Alert', warnings[eventType] || 'Suspicious activity detected!', 'error', 5000);
        }

        function showScreen(screenName, data = {}) {
            state.currentScreen = screenName;
            const app = document.getElementById('app');
            app.innerHTML = '';
            switch (screenName) {
                case 'loading': app.innerHTML = renderLoadingScreen(); break;
                case 'error': app.innerHTML = renderErrorScreen(data.title, data.message); break;
                case 'welcome': app.innerHTML = renderWelcomeScreen(); break;
                case 'instructions': app.innerHTML = renderInstructionsScreen(); break;
                case 'assessment': app.innerHTML = renderAssessmentScreen(); initializeAssessment(); break;
                case 'success': stopWebcam(); app.innerHTML = renderSuccessScreen(); break;
            }
        }

        function renderLoadingScreen() { return `<div class="container"><div class="card"><div class="card-body" style="text-align:center;">Loading Assessment...</div></div></div>`; }
        function renderErrorScreen(title, message) { return `<div class="container"><div class="card"><div class="card-body" style="text-align: center;"><div class="confirmation-icon error" style="margin-top:0;"><i class="fas fa-times-circle"></i></div><h1 style="font-size: 24px;">${title}</h1><p style="color: var(--text-secondary);">${message}</p></div></div></div>`; }
        
        function renderWelcomeScreen() {
            const { title, description, duration, questions, language } = state.assessmentData;
            return `<div class="container"><div class="card"><div class="card-header"><div class="brand-header"><div class="brand-logo">${CONFIG.brandLogo}</div></div><h1>${title}</h1><p>${description}</p></div><div class="card-body"><div class="info-box"><h3><i class="fas fa-info-circle"></i> Details</h3><p><strong>Duration:</strong> ${duration} mins | <strong>Questions:</strong> ${questions.length} | <strong>Language:</strong> ${language}</p></div><div class="form-group"><label class="form-label">Full Name</label><input type="text" id="candidateName" class="form-input" placeholder="Enter your full name" required></div><div class="form-group"><label class="form-label">Email Address</label><input type="email" id="candidateEmail" class="form-input" placeholder="Enter your email address" required></div><div class="warning-box"><h3><i class="fas fa-exclamation-triangle"></i> Before You Begin</h3><ul style="margin: 12px 0 0 20px; font-size: 14px; line-height: 1.6;"><li>Ensure a stable internet connection.</li><li>Your webcam will be active.</li><li>Do not switch tabs or windows.</li></ul></div><div class="btn-group"><button class="btn btn-primary" onclick="proceedToInstructions()"><i class="fas fa-arrow-right"></i> Continue</button></div></div></div></div>`;
        }

        function renderInstructionsScreen() {
            const { duration } = state.assessmentData;
            return `<div class="container"><div class="card"><div class="card-header"><h1>Assessment Instructions</h1><p>Please read carefully before starting</p></div><div class="card-body"><div class="warning-box"><h3><i class="fas fa-video"></i> Proctored Assessment</h3><p>This assessment is monitored. Your webcam will record, and all activities are logged.</p></div><div class="instructions-grid"><div class="instruction-item"><h3><i class="fas fa-clock"></i> Time</h3><p>You have <strong>${duration} minutes</strong>. The test auto-submits when time expires.</p></div><div class="instruction-item"><h3><i class="fas fa-shield-alt"></i> Rules</h3><p>Do not switch tabs, open other apps, or leave the window.</p></div></div><div class="btn-group"><button class="btn btn-secondary" onclick="showScreen('welcome')"><i class="fas fa-arrow-left"></i> Back</button><button class="btn btn-success" onclick="startAssessment()"><i class="fas fa-play"></i> Start Assessment</button></div></div></div></div>`;
        }

        function renderAssessmentScreen() {
            return `<div class="assessment-container"><div class="assessment-header"><div class="assessment-info"><h2>${state.currentUser.name}</h2><p>Question ${state.currentQuestion + 1} of ${state.questions.length}</p></div><div class="assessment-controls"><div id="timer" class="timer"><i class="fas fa-clock"></i> <span id="timeDisplay">00:00</span></div><div class="recording-indicator"><div class="recording-dot"></div>Recording</div></div></div><div class="assessment-content"><div class="questions-panel"><div class="question-nav">${state.questions.map((_, i) => `<div class="question-nav-item ${i === state.currentQuestion ? 'active' : ''} ${state.answers[i] ? 'answered' : ''}" onclick="switchQuestion(${i})">${i + 1}</div>`).join('')}</div><div class="current-question"><h3>${state.questions[state.currentQuestion].title}</h3><p>${state.questions[state.currentQuestion].description}</p>${state.questions[state.currentQuestion].testCases ? `<div class="test-cases"><strong style="font-size: 14px; font-weight: 600; margin-bottom: 12px; display: block;">Test Cases:</strong>${state.questions[state.currentQuestion].testCases.map(test => `<div class="test-case"><div><strong>Input:</strong> ${test.input}</div><div><strong>Expected:</strong> ${test.expected}</div></div>`).join('')}</div>` : ''}</div></div><div class="editor-panel"><div class="editor-header"><div class="editor-tab">Solution</div></div><div id="codeEditor"></div><div class="status-bar"><span>Language: ${state.questions[state.currentQuestion].language}</span><button class="btn btn-primary" onclick="showConfirmSubmission()"><i class="fas fa-paper-plane"></i> Submit Assessment</button></div></div></div><div id="webcamPreview" class="webcam-preview hidden"><video id="webcamVideo" autoplay muted playsinline></video></div></div>`;
        }

        function renderSuccessScreen() { return `<div class="container"><div class="card"><div class="card-body success-screen"><div class="success-icon"><i class="fas fa-check"></i></div><h1>Assessment Submitted!</h1><p>Thank you. Your responses have been recorded. You may now close this window.</p></div></div></div>`; }

        async function initializeAssessment() {
            await setupWebcam();
            const editorElement = document.getElementById('codeEditor');
            if (editorElement) {
                const editor = CodeMirror(editorElement, { value: state.answers[state.currentQuestion] || state.questions[state.currentQuestion].starter || '', mode: state.questions[state.currentQuestion].language, theme: 'github', lineNumbers: true, autoCloseBrackets: true, matchBrackets: true });
                state.editors[state.currentQuestion] = editor;
                editor.on('change', () => { state.answers[state.currentQuestion] = editor.getValue(); updateQuestionNavigation(); });
                setTimeout(() => editor.refresh(), 1);
            }
        }

        function switchQuestion(index) {
            if (index === state.currentQuestion) return;
            state.currentQuestion = index;
            showScreen('assessment');
        }

        function updateQuestionNavigation() {
            document.querySelectorAll('.question-nav-item').forEach((item, index) => item.classList.toggle('answered', !!(state.answers[index] && state.answers[index].trim())));
        }

        function startTimer(seconds) {
            state.timeLeft = seconds;
            const update = () => {
                const mins = Math.floor(state.timeLeft / 60).toString().padStart(2, '0');
                const secs = (state.timeLeft % 60).toString().padStart(2, '0');
                const timerEl = document.getElementById('timeDisplay');
                if (timerEl) {
                    timerEl.textContent = `${mins}:${secs}`;
                    timerEl.parentElement.className = 'timer';
                    if (state.timeLeft < 300) timerEl.parentElement.classList.add('danger');
                    else if (state.timeLeft < 600) timerEl.parentElement.classList.add('warning');
                }
                if (state.timeLeft <= 0) { clearInterval(state.timer); submitAssessment(); }
                state.timeLeft--;
            };
            update();
            state.timer = setInterval(update, 1000);
        }

        async function showConfirmSubmission() {
            const confirmed = await showCustomConfirm('Submit Assessment?', 'Are you sure you want to end the assessment? This action cannot be undone.');
            if (confirmed) await submitAssessment();
        }

        async function submitAssessment() {
            if (state.timer) clearInterval(state.timer);
            stopWebcam();
            const submissionData = { candidate_name: state.currentUser.name, candidate_email: state.currentUser.email, assessment_id: state.assessmentData.id, questions: state.questions.map(q => ({ id: q.id, title: q.title })), answers: state.answers, cheating_logs: state.cheatingLogs, submitted_at: new Date().toISOString(), time_taken: (state.assessmentData.duration * 60) - state.timeLeft, };
            if (supabaseClient) {
                try {
                    const { error } = await supabaseClient.from('submissions').insert(submissionData);
                    if (error) throw error;
                    if (state.assessmentData.invitation_token) { await supabaseClient.from('invitations').update({ status: 'completed', completed_at: new Date().toISOString() }).eq('invitation_token', state.assessmentData.invitation_token); }
                } catch (dbError) {
                    console.error('DB submission error:', dbError);
                    localStorage.setItem('assessment_backup', JSON.stringify(submissionData));
                }
            } else { localStorage.setItem('assessment_backup', JSON.stringify(submissionData)); }
            showScreen('success');
        }

        function proceedToInstructions() {
            const name = document.getElementById('candidateName').value.trim();
            const email = document.getElementById('candidateEmail').value.trim();
            if (!name || !email) return showCustomToast('Required Fields', 'Please enter your name and email.', 'error');
            state.currentUser = { name, email };
            showScreen('instructions');
        }

        function startAssessment() {
            state.questions = state.assessmentData.questions;
            state.answers = new Array(state.questions.length).fill('');
            state.currentQuestion = 0;
            setupCheatingDetection();
            startTimer(state.assessmentData.duration * 60);
            showScreen('assessment');
        }

        async function validateAndLoadAssessment() {
            const urlParams = new URLSearchParams(window.location.search);
            const assessmentId = urlParams.get('assessment');
            const token = urlParams.get('token');
            if (!assessmentId || !token) { state.assessmentData = getDemoAssessment(); return showScreen('welcome'); }
            if (!supabaseClient) return showScreen('error', { title: 'Configuration Error', message: 'This platform is not connected to a database.' });
            try {
                const { data: invitation, error: inviteError } = await supabaseClient.from('invitations').select('*').eq('invitation_token', token).eq('assessment_id', assessmentId).single();
                if (inviteError || !invitation) return showScreen('error', { title: 'Invalid Link', message: 'This assessment link is not valid.' });
                if (invitation.status !== 'sent') return showScreen('error', { title: 'Link Used', message: 'This assessment has already been completed or expired.' });
                if (new Date(invitation.expires_at) < new Date()) return showScreen('error', { title: 'Link Expired', message: 'The deadline for this assessment has passed.' });
                const { data: template, error: templateError } = await supabaseClient.from('assessment_templates').select('*').eq('id', assessmentId).single();
                if (templateError || !template) return showScreen('error', { title: 'Assessment Not Found', message: 'The requested assessment could not be loaded.' });
                state.assessmentData = { ...template, duration: invitation.duration || template.default_duration, invitation_token: token, };
                showScreen('welcome');
            } catch (err) {
                console.error("Validation Error:", err);
                showScreen('error', { title: 'An Error Occurred', message: 'Could not load the assessment.' });
            }
        }

        function getDemoAssessment() {
            return { id: 'js-fundamentals', title: 'JavaScript Fundamentals (Demo)', description: 'A sample assessment to test your skills.', duration: 15, language: 'JavaScript', questions: [{ id: 1, title: "Array Sum", description: "Write a function to sum all even numbers in an array.", language: "javascript", starter: "function sumEven(arr) {\n  // your code here\n}", testCases: [{input: "[1,2,3,4]", expected: "6"}] }] };
        }

        document.addEventListener('DOMContentLoaded', validateAndLoadAssessment);
    </script>
</body>
</html>
