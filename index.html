<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechAssess Pro - Assessment Platform</title>
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/github.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a1a1a;
            --primary-hover: #2a2a2a;
            --secondary: #f8f9fa;
            --accent: #e9ecef;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --radius: 8px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Toast System */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }

        .toast {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            min-width: 320px;
            max-width: 400px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            font-family: inherit;
            pointer-events: auto;
        }

        .toast.success { border-left: 4px solid var(--success); }
        .toast.warning { border-left: 4px solid var(--warning); }
        .toast.error { border-left: 4px solid var(--error); }
        .toast.info { border-left: 4px solid var(--primary); }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .toast-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: var(--text-secondary);
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .toast-close:hover {
            opacity: 1;
        }

        /* Confirmation Modal */
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            animation: fadeIn 0.2s ease;
        }

        .confirmation-content {
            background: white;
            border-radius: var(--radius);
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: scaleIn 0.3s ease;
        }

        .confirmation-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .confirmation-icon.warning { background: var(--warning); }
        .confirmation-icon.error { background: var(--error); }
        .confirmation-icon.info { background: var(--primary); }

        .confirmation-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .confirmation-message {
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .confirmation-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        /* Webcam Preview */
        .webcam-preview {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border: 3px solid var(--primary);
            border-radius: var(--radius);
            overflow: hidden;
            background: black;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .webcam-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .webcam-preview::after {
            content: "Recording";
            position: absolute;
            top: 8px;
            left: 8px;
            background: var(--error);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        /* Assessment Container */
        .assessment-container {
            background: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Main Layout */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card {
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            background: var(--secondary);
            padding: 32px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .brand-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .brand-logo {
            width: 60px;
            height: 60px;
            background: var(--primary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 24px;
        }

        .card-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .card-header p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .card-body {
            padding: 32px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 16px;
            background: white;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.1);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px 24px;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            min-height: 48px;
            font-family: inherit;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(26, 26, 26, 0.2);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--secondary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #16a34a;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .btn-group {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 32px;
        }

        /* Info Boxes */
        .info-box {
            background: var(--accent);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin: 20px 0;
        }

        .warning-box {
            background: #fef3c7;
            border: 1px solid #ffeaa7;
            border-left: 4px solid #f39c12;
            border-radius: var(--radius);
            padding: 20px;
            margin: 20px 0;
        }

        .warning-box h3 {
            color: #92400e;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Instructions Grid */
        .instructions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }

        .instruction-item {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }

        .instruction-item h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Assessment Layout */
        .assessment-header {
            background: white;
            border-bottom: 2px solid var(--border);
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .assessment-info h2 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .assessment-info p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .assessment-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .timer {
            background: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: 24px;
            font-weight: 700;
            font-family: monospace;
            font-size: 16px;
        }

        .timer.warning { 
            background: var(--warning); 
            color: var(--text-primary); 
        }
        
        .timer.danger { 
            background: var(--error); 
            animation: pulse 1s infinite;
        }

        .recording-indicator {
            background: var(--error);
            color: white;
            padding: 12px 20px;
            border-radius: 24px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .recording-dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .assessment-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 0;
        }

        .questions-panel {
            width: 360px;
            background: var(--secondary);
            border-right: 2px solid var(--border);
            padding: 24px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .question-nav {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(48px, 1fr));
            gap: 12px;
            margin-bottom: 32px;
        }

        .question-nav-item {
            width: 48px;
            height: 48px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 700;
            font-size: 16px;
            background: white;
            transition: all 0.2s;
        }

        .question-nav-item:hover {
            border-color: var(--primary);
        }

        .question-nav-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .question-nav-item.answered {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .current-question {
            background: white;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            overflow-y: auto;
            max-height: calc(100vh - 300px);
        }

        .current-question h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .current-question p {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 20px;
        }

        .test-cases {
            margin-top: 20px;
        }

        .test-case {
            background: var(--accent);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
        }

        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
            min-width: 0;
        }

        .editor-header {
            padding: 16px 24px;
            background: var(--secondary);
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .editor-tab {
            background: white;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
        }

        .editor-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .auto-save-indicator {
            color: var(--success);
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .editor-container {
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }

        .CodeMirror {
            height: 100% !important;
            font-size: 16px;
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            border: none;
        }

        .CodeMirror-focused .CodeMirror-cursor {
            border-left: 2px solid var(--primary);
        }

        .status-bar {
            padding: 16px 24px;
            background: var(--secondary);
            border-top: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        /* Success Screen */
        .success-screen {
            text-align: center;
            padding: 48px 32px;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            color: white;
            font-size: 32px;
        }

        /* Error Screen */
        .error-screen {
            text-align: center;
            padding: 48px 32px;
        }

        .error-icon {
            width: 80px;
            height: 80px;
            background: var(--error);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            color: white;
            font-size: 32px;
        }

        .hidden {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 20px 10px;
            }

            .assessment-content {
                flex-direction: column;
            }

            .questions-panel {
                width: 100%;
                max-height: 250px;
                border-right: none;
                border-bottom: 2px solid var(--border);
            }

            .current-question {
                max-height: 200px;
            }

            .btn-group {
                flex-direction: column;
            }

            .webcam-preview {
                width: 150px;
                height: 112px;
                bottom: 10px;
                right: 10px;
            }

            .assessment-header {
                padding: 16px 20px;
            }

            .assessment-controls {
                gap: 12px;
            }

            .timer,
            .recording-indicator {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Security Alert Overlay */
        .security-alert {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(239, 68, 68, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            animation: fadeIn 0.3s ease;
        }

        .security-alert-content {
            background: white;
            border-radius: var(--radius);
            padding: 40px;
            text-align: center;
            max-width: 500px;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .security-alert-icon {
            width: 80px;
            height: 80px;
            background: var(--error);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            color: white;
            font-size: 32px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Content will be dynamically loaded here -->
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Webcam Preview -->
    <div id="webcamPreview" class="webcam-preview hidden">
        <video id="webcamVideo" autoplay muted playsinline></video>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>

    <script>
        // PRODUCTION CONFIGURATION - Should be set via environment variables
        const CONFIG = {
            supabaseUrl: "https://ytoidmelmialrjfqyhet.supabase.co",
            supabaseAnonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0b2lkbWVsbWlhbHJqZnF5aGV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMTg3NzYsImV4cCI6MjA2OTg5NDc3Nn0.4D_ohY9wqeBb8Rod8dlhrn5Jjl10QNzU-AeCDHUixv4",
            brandName: "TechAssess Pro",
            brandLogo: "TA"
        };

        // Global State
        const state = {
            currentScreen: 'welcome',
            currentUser: null,
            currentQuestion: 0,
            questions: [],
            answers: [],
            cheatingLogs: [],
            mediaRecorder: null,
            videoStream: null,
            videoChunks: [],
            editors: {},
            timer: null,
            timeLeft: 0,
            supabaseClient: null,
            assessmentDuration: 60,
            invitationToken: null,
            assessmentId: null,
            assessmentInfo: null,
            isMouseTracking: false,
            securityAlertShown: false
        };

        // Initialize Supabase
        let supabaseClient = null;
        if (typeof supabase !== 'undefined' && CONFIG.supabaseUrl && CONFIG.supabaseAnonKey) {
            try {
                supabaseClient = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseAnonKey);
                state.supabaseClient = supabaseClient;
                console.log('✅ Supabase initialized successfully');
            } catch (error) {
                console.error('❌ Failed to initialize Supabase:', error);
            }
        }

        // Toast System
        function showToast(title, message, type = 'success', duration = 5000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(toast);

            if (duration > 0) {
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, duration);
            }
        }

        // Confirmation Modal
        function showConfirm(title, message, type = 'warning') {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'confirmation-modal';
                
                const iconClass = type === 'error' ? 'fas fa-exclamation-triangle' : 
                                type === 'info' ? 'fas fa-info-circle' : 'fas fa-question-circle';
                
                modal.innerHTML = `
                    <div class="confirmation-content">
                        <div class="confirmation-icon ${type}">
                            <i class="${iconClass}"></i>
                        </div>
                        <div class="confirmation-title">${title}</div>
                        <div class="confirmation-message">${message}</div>
                        <div class="confirmation-buttons">
                            <button class="btn btn-secondary" onclick="closeConfirmation(false)">Cancel</button>
                            <button class="btn btn-primary" onclick="closeConfirmation(true)">Confirm</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                window.closeConfirmation = (result) => {
                    modal.remove();
                    delete window.closeConfirmation;
                    resolve(result);
                };
            });
        }

        // Security Alert
        function showSecurityAlert(title, message) {
            if (state.securityAlertShown) return;
            
            state.securityAlertShown = true;
            const alert = document.createElement('div');
            alert.className = 'security-alert';
            
            alert.innerHTML = `
                <div class="security-alert-content">
                    <div class="security-alert-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h2 style="color: var(--error); margin-bottom: 16px;">${title}</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 24px;">${message}</p>
                    <button class="btn btn-danger" onclick="this.parentElement.parentElement.remove(); state.securityAlertShown = false;">
                        I Understand
                    </button>
                </div>
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                    state.securityAlertShown = false;
                }
            }, 10000);
        }

        // Assessment Loading and Validation
        async function validateAndLoadAssessment() {
            const urlParams = new URLSearchParams(window.location.search);
            const assessmentId = urlParams.get('assessment');
            const inviteToken = urlParams.get('token');
            
            if (assessmentId && inviteToken) {
                state.invitationToken = inviteToken;
                state.assessmentId = assessmentId;
                
                if (!supabaseClient) {
                    showErrorScreen('Database Connection Error', 'Unable to validate assessment invitation. Please contact support.');
                    return null;
                }
                
                try {
                    showToast('Validating', 'Checking invitation validity...', 'info');
                    
                    // Validate invitation token
                    const { data: invitation, error } = await supabaseClient
                        .from('invitations')
                        .select('*')
                        .eq('invitation_token', inviteToken)
                        .eq('assessment_id', assessmentId)
                        .eq('status', 'sent')
                        .single();
                    
                    if (error || !invitation) {
                        showErrorScreen('Invalid Invitation', 'This invitation link is invalid or has been used. Please contact the administrator for a new link.');
                        return null;
                    }
                    
                    // Check expiration
                    if (new Date(invitation.expires_at) < new Date()) {
                        showErrorScreen('Invitation Expired', 'This assessment invitation has expired. Please contact the administrator for a new link.');
                        return null;
                    }
                    
                    // Check for existing submission
                    const { data: existingSubmission } = await supabaseClient
                        .from('submissions')
                        .select('id')
                        .eq('invitation_id', invitation.id)
                        .single();
                    
                    if (existingSubmission) {
                        showErrorScreen('Already Submitted', 'This assessment has already been completed using this invitation link.');
                        return null;
                    }
                    
                    // Load assessment questions
                    return await loadAssessmentQuestions(assessmentId, invitation.duration);
                    
                } catch (validationError) {
                    console.error('Token validation failed:', validationError);
                    showErrorScreen('Validation Error', 'Unable to validate invitation. Please contact support.');
                    return null;
                }
            }
            
            // For demo/testing without token
            return getDefaultAssessment();
        }

        async function loadAssessmentQuestions(assessmentId, overrideDuration) {
            try {
                // Try to load from database first
                const { data: assessment, error } = await supabaseClient
                    .from('assessments')
                    .select('*')
                    .eq('id', assessmentId)
                    .single();
                
                if (!error && assessment) {
                    // Apply duration override if provided
                    if (overrideDuration) {
                        assessment.duration = overrideDuration;
                    }
                    return assessment;
                }
            } catch (error) {
                console.error('Failed to load assessment from database:', error);
            }
            
            // Fallback to default assessment
            return getDefaultAssessment();
        }

        function getDefaultAssessment() {
            return {
                id: 'default',
                title: 'JavaScript Assessment',
                description: 'Test your programming skills',
                duration: 60,
                language: 'JavaScript',
                difficulty: 'Mixed',
                questions: [
                    {
                        id: 1,
                        title: "Array Sum of Evens",
                        description: "Write a function that takes an array of integers and returns the sum of all even numbers. Handle edge cases like empty arrays.",
                        language: "javascript",
                        starter: "function sumEvenNumbers(arr) {\n    // Handle edge cases\n    if (!arr || arr.length === 0) {\n        return 0;\n    }\n    \n    // Your code here\n    \n}",
                        testCases: [
                            { input: "[1, 2, 3, 4, 5, 6]", expected: "12", description: "Mixed odd and even numbers" },
                            { input: "[2, 4, 6, 8]", expected: "20", description: "All even numbers" },
                            { input: "[1, 3, 5, 7]", expected: "0", description: "All odd numbers" },
                            { input: "[]", expected: "0", description: "Empty array" }
                        ]
                    },
                    {
                        id: 2,
                        title: "String Word Reversal",
                        description: "Create a function that reverses each word in a sentence while keeping the word order intact. For example: 'hello world' becomes 'olleh dlrow'.",
                        language: "javascript",
                        starter: "function reverseWords(sentence) {\n    // Handle edge cases\n    if (!sentence || typeof sentence !== 'string') {\n        return '';\n    }\n    \n    // Your code here\n    \n}",
                        testCases: [
                            { input: "'hello world'", expected: "'olleh dlrow'", description: "Two words" },
                            { input: "'javascript is awesome'", expected: "'tpircsavaj si emosewa'", description: "Three words" },
                            { input: "'a'", expected: "'a'", description: "Single character" },
                            { input: "''", expected: "''", description: "Empty string" }
                        ]
                    },
                    {
                        id: 3,
                        title: "Palindrome Finder",
                        description: "Implement a function to find the longest palindromic substring in a given string. A palindrome reads the same forwards and backwards.",
                        language: "javascript",
                        starter: "function longestPalindrome(s) {\n    // Handle edge cases\n    if (!s || s.length < 2) {\n        return s || '';\n    }\n    \n    // Your approach here\n    // Consider: expand around centers method\n    \n}",
                        testCases: [
                            { input: "'babad'", expected: "'bab' or 'aba'", description: "Multiple valid palindromes" },
                            { input: "'cbbd'", expected: "'bb'", description: "Even length palindrome" },
                            { input: "'racecar'", expected: "'racecar'", description: "Entire string is palindrome" },
                            { input: "'abc'", expected: "'a', 'b', or 'c'", description: "No multi-character palindrome" }
                        ]
                    }
                ]
            };
        }

        // Screen Management
        function showScreen(screenName) {
            state.currentScreen = screenName;
            const app = document.getElementById('app');
            
            switch (screenName) {
                case 'welcome':
                    app.innerHTML = renderWelcomeScreen();
                    break;
                case 'instructions':
                    app.innerHTML = renderInstructionsScreen();
                    break;
                case 'assessment':
                    app.innerHTML = renderAssessmentScreen();
                    initializeAssessment();
                    break;
                case 'success':
                    app.innerHTML = renderSuccessScreen();
                    break;
            }
        }

        function showErrorScreen(title, message) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="card">
                        <div class="card-body error-screen">
                            <div class="error-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h1 style="font-size: 32px; font-weight: 700; margin-bottom: 16px; color: var(--error);">${title}</h1>
                            <p style="color: var(--text-secondary); margin-bottom: 32px; font-size: 18px;">
                                ${message}
                            </p>
                            <div class="info-box">
                                <h3 style="margin-bottom: 16px; font-size: 16px; font-weight: 600;">What can you do?</h3>
                                <ul style="text-align: left; font-size: 14px; line-height: 1.6;">
                                    <li>Contact the assessment administrator for a new invitation link</li>
                                    <li>Check that you're using the correct link provided to you</li>
                                    <li>Ensure you haven't already completed this assessment</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Screen Renderers
        function renderWelcomeScreen() {
            const assessmentInfo = state.assessmentInfo || getDefaultAssessment();
            
            return `
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <div class="brand-header">
                                <div class="brand-logo">${CONFIG.brandLogo}</div>
                                <div>
                                    <h1>${assessmentInfo.title}</h1>
                                    <p>${assessmentInfo.description}</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="info-box">
                                <h3 style="margin-bottom: 12px; font-size: 16px; font-weight: 600;"><i class="fas fa-info-circle"></i> Assessment Details</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; font-size: 14px;">
                                    <div><strong>Duration:</strong> ${assessmentInfo.duration} minutes</div>
                                    <div><strong>Questions:</strong> ${assessmentInfo.questions.length}</div>
                                    <div><strong>Language:</strong> ${assessmentInfo.language}</div>
                                    <div><strong>Difficulty:</strong> ${assessmentInfo.difficulty}</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" id="candidateName" class="form-input" placeholder="Enter your full name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input type="email" id="candidateEmail" class="form-input" placeholder="Enter your email address" required>
                            </div>
                            
                            <div class="warning-box">
                                <h3><i class="fas fa-exclamation-triangle"></i> Before You Begin</h3>
                                <ul style="margin: 12px 0 0 20px; font-size: 14px; line-height: 1.6;">
                                    <li>Ensure you have a stable internet connection</li>
                                    <li>Your webcam will be active throughout the assessment</li>
                                    <li>Do not switch tabs or windows during the assessment</li>
                                    <li>The assessment will auto-submit when time expires</li>
                                    <li>Keep your mouse cursor within the assessment window</li>
                                </ul>
                            </div>
                            
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="proceedToInstructions()" id="continueBtn">
                                    <i class="fas fa-arrow-right"></i> Continue
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderInstructionsScreen() {
            const assessmentInfo = state.assessmentInfo || getDefaultAssessment();
            
            return `
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <div class="brand-header">
                                <div class="brand-logo">${CONFIG.brandLogo}</div>
                                <div>
                                    <h1>Assessment Instructions</h1>
                                    <p>Please read carefully before starting</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="warning-box">
                                <h3><i class="fas fa-video"></i> Proctored Assessment</h3>
                                <p>This assessment is monitored. Your webcam will record throughout the session, and all activities are logged for security purposes.</p>
                            </div>
                            
                            <div class="instructions-grid">
                                <div class="instruction-item">
                                    <h3><i class="fas fa-clock"></i> Time Management</h3>
                                    <p>You have <strong>${assessmentInfo.duration} minutes</strong> to complete all questions. The assessment will auto-submit when time expires.</p>
                                </div>
                                
                                <div class="instruction-item">
                                    <h3><i class="fas fa-shield-alt"></i> Security Rules</h3>
                                    <p>Do not switch tabs, open other applications, or move your cursor outside the assessment window. All activities are monitored.</p>
                                </div>
                                
                                <div class="instruction-item">
                                    <h3><i class="fas fa-code"></i> Coding Guidelines</h3>
                                    <p>Write clean, well-commented code. Test your solutions with the provided examples.</p>
                                </div>
                                
                                <div class="instruction-item">
                                    <h3><i class="fas fa-save"></i> Auto-Save</h3>
                                    <p>Your progress is automatically saved. You can navigate between questions safely.</p>
                                </div>
                            </div>
                            
                            <div class="info-box">
                                <h3 style="margin-bottom: 12px; font-size: 16px; font-weight: 600;">Assessment Overview</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; font-size: 14px;">
                                    <div><strong>Assessment:</strong> ${assessmentInfo.title}</div>
                                    <div><strong>Questions:</strong> ${assessmentInfo.questions.length}</div>
                                    <div><strong>Language:</strong> ${assessmentInfo.language}</div>
                                    <div><strong>Duration:</strong> ${assessmentInfo.duration} minutes</div>
                                </div>
                            </div>
                            
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="showScreen('welcome')">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                                <button class="btn btn-success" onclick="startAssessment()" id="startBtn">
                                    <i class="fas fa-play"></i> Start Assessment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAssessmentScreen() {
            return `
                <div class="assessment-container">
                    <div class="assessment-header">
                        <div class="assessment-info">
                            <h2>${state.currentUser.name}</h2>
                            <p>Question ${state.currentQuestion + 1} of ${state.questions.length}</p>
                        </div>
                        <div class="assessment-controls">
                            <div id="timer" class="timer">
                                <i class="fas fa-clock"></i> <span id="timeDisplay">00:00</span>
                            </div>
                            <div class="recording-indicator">
                                <div class="recording-dot"></div>
                                Recording
                            </div>
                        </div>
                    </div>
                    
                    <div class="assessment-content">
                        <div class="questions-panel">
                            <div class="question-nav">
                                ${state.questions.map((_, index) => `
                                    <div class="question-nav-item ${index === state.currentQuestion ? 'active' : ''} ${state.answers[index] && state.answers[index].trim() ? 'answered' : ''}" 
                                         onclick="switchQuestion(${index})">
                                        ${index + 1}
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="current-question">
                                <h3>${state.questions[state.currentQuestion].title}</h3>
                                <p>${state.questions[state.currentQuestion].description}</p>
                                
                                ${state.questions[state.currentQuestion].testCases ? `
                                    <div class="test-cases">
                                        <strong style="font-size: 14px; font-weight: 600; margin-bottom: 12px; display: block;">Test Cases:</strong>
                                        ${state.questions[state.currentQuestion].testCases.map((test, i) => `
                                            <div class="test-case">
                                                <div><strong>Input:</strong> ${test.input}</div>
                                                <div><strong>Expected:</strong> ${test.expected}</div>
                                                ${test.description ? `<div style="font-style: italic; color: var(--text-secondary); margin-top: 4px;">${test.description}</div>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="editor-panel">
                            <div class="editor-header">
                                <div class="editor-tab">Solution</div>
                                <div class="editor-actions">
                                    <div class="auto-save-indicator">
                                        <i class="fas fa-check-circle"></i> Auto-saved
                                    </div>
                                    <button class="btn btn-secondary btn-sm" onclick="resetCurrentAnswer()">
                                        <i class="fas fa-undo"></i> Reset
                                    </button>
                                </div>
                            </div>
                            
                            <div class="editor-container">
                                <div id="codeEditor"></div>
                            </div>
                            
                            <div class="status-bar">
                                <div>
                                    <span>Language: ${state.questions[state.currentQuestion].language}</span>
                                    <span style="margin-left: 20px;">Line: <span id="currentLine">1</span>, Column: <span id="currentColumn">1</span></span>
                                </div>
                                <div>
                                    <button class="btn btn-primary" onclick="showConfirmSubmission()" style="padding: 12px 20px; font-size: 14px;">
                                        <i class="fas fa-paper-plane"></i> Submit Assessment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSuccessScreen() {
            return `
                <div class="container">
                    <div class="card">
                        <div class="card-body success-screen">
                            <div class="success-icon">
                                <i class="fas fa-check"></i>
                            </div>
                            <h1 style="font-size: 32px; font-weight: 700; margin-bottom: 16px;">Assessment Submitted Successfully!</h1>
                            <p style="color: var(--text-secondary); margin-bottom: 32px; font-size: 18px;">
                                Thank you for completing the assessment. Your responses have been recorded and will be reviewed by our team.
                            </p>
                            <div class="info-box">
                                <h3 style="margin-bottom: 16px; font-size: 16px; font-weight: 600;">Submission Details</h3>
                                <div style="font-size: 14px; text-align: left;">
                                    <p><strong>Candidate:</strong> ${state.currentUser?.name}</p>
                                    <p><strong>Email:</strong> ${state.currentUser?.email}</p>
                                    <p><strong>Questions Completed:</strong> ${state.answers.filter(a => a && a.trim()).length} of ${state.questions.length}</p>
                                    <p><strong>Submitted At:</strong> ${new Date().toLocaleString()}</p>
                                    <p><strong>Security Events:</strong> ${state.cheatingLogs.length} logged</p>
                                </div>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 14px; margin-top: 24px;">
                                You may now close this window. Results will be communicated separately.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Event Handlers
        function proceedToInstructions() {
            const name = document.getElementById('candidateName').value.trim();
            const email = document.getElementById('candidateEmail').value.trim();
            
            if (!name || !email) {
                showToast('Required Fields', 'Please fill in all required fields.', 'error');
                return;
            }
            
            if (!isValidEmail(email)) {
                showToast('Invalid Email', 'Please enter a valid email address.', 'error');
                return;
            }
            
            const continueBtn = document.getElementById('continueBtn');
            continueBtn.disabled = true;
            continueBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            state.currentUser = { name, email };
            showToast('Information Saved', 'Proceeding to assessment instructions...', 'success', 2000);
            
            setTimeout(() => {
                showScreen('instructions');
                continueBtn.disabled = false;
                continueBtn.innerHTML = '<i class="fas fa-arrow-right"></i> Continue';
            }, 1000);
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        async function startAssessment() {
            try {
                const startBtn = document.getElementById('startBtn');
                startBtn.disabled = true;
                startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Initializing...';
                
                showToast('Initializing', 'Setting up your assessment environment...', 'info', 3000);
                
                const assessmentInfo = state.assessmentInfo;
                if (!assessmentInfo) {
                    showToast('Error', 'Assessment not found.', 'error');
                    return;
                }
                
                state.questions = assessmentInfo.questions;
                state.answers = new Array(state.questions.length).fill('');
                state.currentQuestion = 0;
                state.assessmentDuration = assessmentInfo.duration;
                
                // Setup webcam and recording
                await setupWebcam();
                
                // Setup enhanced cheating detection
                setupCheatingDetection();
                
                // Start timer
                startTimer(assessmentInfo.duration * 60);
                
                showScreen('assessment');
                showToast('Assessment Started', `You have ${assessmentInfo.duration} minutes to complete all questions.`, 'success', 4000);
                
            } catch (error) {
                console.error('Failed to start assessment:', error);
                showToast('Setup Failed', 'Failed to start assessment. Please check your webcam permissions and try again.', 'error');
                
                const startBtn = document.getElementById('startBtn');
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-play"></i> Start Assessment';
            }
        }

        function initializeAssessment() {
            const editorElement = document.getElementById('codeEditor');
            if (editorElement) {
                const currentQuestion = state.questions[state.currentQuestion];
                const editor = CodeMirror(editorElement, {
                    value: state.answers[state.currentQuestion] || currentQuestion.starter || '',
                    mode: currentQuestion.language === 'python' ? 'python' : 'javascript',
                    theme: 'github',
                    lineNumbers: true,
                    lineWrapping: true,
                    autoCloseBrackets: true,
                    matchBrackets: true,
                    indentUnit: 4,
                    tabSize: 4,
                    smartIndent: true,
                    extraKeys: {
                        "Ctrl-Space": "autocomplete",
                        "Tab": (cm) => {
                            if (cm.somethingSelected()) {
                                cm.indentSelection("add");
                            } else {
                                cm.replaceSelection(cm.getOption("indentWithTabs") ? "\t" : " ".repeat(cm.getOption("indentUnit")), "end");
                            }
                        }
                    }
                });
                
                state.editors[state.currentQuestion] = editor;
                
                // Auto-save on change
                editor.on('change', () => {
                    state.answers[state.currentQuestion] = editor.getValue();
                    updateQuestionNavigation();
                });

                // Update cursor position
                editor.on('cursorActivity', () => {
                    const cursor = editor.getCursor();
                    document.getElementById('currentLine').textContent = cursor.line + 1;
                    document.getElementById('currentColumn').textContent = cursor.ch + 1;
                });
                
                // Refresh the editor to ensure proper display
                setTimeout(() => {
                    editor.refresh();
                    editor.focus();
                }, 100);
            }
        }

        function switchQuestion(questionIndex) {
            if (questionIndex === state.currentQuestion) return;
            
            // Save current answer
            if (state.editors[state.currentQuestion]) {
                state.answers[state.currentQuestion] = state.editors[state.currentQuestion].getValue();
            }
            
            state.currentQuestion = questionIndex;
            showScreen('assessment');
            showToast('Question Changed', `Switched to question ${questionIndex + 1}`, 'info', 2000);
        }

        function updateQuestionNavigation() {
            const navItems = document.querySelectorAll('.question-nav-item');
            navItems.forEach((item, index) => {
                item.className = 'question-nav-item';
                if (index === state.currentQuestion) {
                    item.classList.add('active');
                }
                if (state.answers[index] && state.answers[index].trim()) {
                    item.classList.add('answered');
                }
            });
        }

        function resetCurrentAnswer() {
            if (confirm('Are you sure you want to reset your code for this question? This action cannot be undone.')) {
                const currentQuestion = state.questions[state.currentQuestion];
                state.answers[state.currentQuestion] = currentQuestion.starter || '';
                
                if (state.editors[state.currentQuestion]) {
                    state.editors[state.currentQuestion].setValue(state.answers[state.currentQuestion]);
                }
                
                updateQuestionNavigation();
                showToast('Code Reset', 'Your code has been reset to the starter template.', 'warning');
            }
        }

        async function showConfirmSubmission() {
            const answeredQuestions = state.answers.filter(a => a && a.trim()).length;
            const totalQuestions = state.questions.length;
            
            const confirmed = await showConfirm(
                'Submit Assessment',
                `Are you sure you want to submit your assessment? You have answered ${answeredQuestions} out of ${totalQuestions} questions. This action cannot be undone.`,
                'warning'
            );
            
            if (confirmed) {
                await submitAssessment();
            }
        }

        async function submitAssessment() {
            try {
                showToast('Submitting', 'Processing your submission...', 'info');
                
                // Save current answer
                if (state.editors[state.currentQuestion]) {
                    state.answers[state.currentQuestion] = state.editors[state.currentQuestion].getValue();
                }
                
                // Stop recording
                if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                    state.mediaRecorder.stop();
                }
                
                // Stop timer
                if (state.timer) {
                    clearInterval(state.timer);
                }
                
                // Prepare submission data
                const submissionData = {
                    candidate_name: state.currentUser.name,
                    candidate_email: state.currentUser.email,
                    invitation_id: state.invitationToken ? await getInvitationId() : null,
                    assessment_id: state.assessmentId,
                    questions: state.questions.map(q => ({
                        id: q.id,
                        title: q.title,
                        description: q.description
                    })),
                    answers: state.answers,
                    cheating_logs: state.cheatingLogs,
                    submitted_at: new Date().toISOString(),
                    time_taken: calculateTimeTaken(),
                    duration_allocated: state.assessmentDuration * 60,
                    score: calculateScore(),
                    ip_address: await getClientIP(),
                    user_agent: navigator.userAgent,
                    browser_fingerprint: generateBrowserFingerprint()
                };
                
                // Submit to database
                if (state.supabaseClient) {
                    try {
                        const { data: submission, error } = await state.supabaseClient
                            .from('submissions')
                            .insert(submissionData)
                            .select()
                            .single();
                        
                        if (error) {
                            throw error;
                        }
                        
                        // Update invitation status if exists
                        if (state.invitationToken) {
                            const invitationId = await getInvitationId();
                            if (invitationId) {
                                await state.supabaseClient
                                    .from('invitations')
                                    .update({ 
                                        status: 'completed',
                                        completed_at: new Date().toISOString()
                                    })
                                    .eq('id', invitationId);
                            }
                        }
                        
                        console.log('✅ Submission saved successfully:', submission.id);
                        
                    } catch (dbError) {
                        console.error('❌ Database submission error:', dbError);
                        // Fallback to local storage
                        localStorage.setItem('assessment_backup', JSON.stringify(submissionData));
                        showToast('Submission Warning', 'Your answers were saved locally. Please contact support.', 'warning');
                    }
                } else {
                    // Fallback to local storage
                    localStorage.setItem('assessment_backup', JSON.stringify(submissionData));
                    showToast('Offline Mode', 'Your answers have been saved locally.', 'warning');
                }
                
                showScreen('success');
                showToast('Success', 'Your assessment has been submitted successfully!', 'success', 0);
                
            } catch (error) {
                console.error('Failed to submit assessment:', error);
                showToast('Submission Failed', 'Failed to submit assessment. Please try again.', 'error');
            }
        }

        // Webcam and Recording Setup
        async function setupWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    }, 
                    audio: true 
                });
                
                // Show webcam preview
                const video = document.getElementById('webcamVideo');
                const preview = document.getElementById('webcamPreview');
                if (video && preview) {
                    video.srcObject = stream;
                    preview.classList.remove('hidden');
                }
                
                state.videoStream = stream;
                state.videoChunks = [];
                state.mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp8,opus'
                });
                
                state.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        state.videoChunks.push(event.data);
                    }
                };
                
                state.mediaRecorder.onstop = async () => {
                    const blob = new Blob(state.videoChunks, { type: 'video/webm' });
                    
                    if (state.supabaseClient) {
                        const fileName = `recording-${Date.now()}-${state.currentUser.name.replace(/\s+/g, '-').toLowerCase()}.webm`;
                        
                        try {
                            const { data, error } = await state.supabaseClient.storage
                                .from('recordings')
                                .upload(fileName, blob, {
                                    contentType: 'video/webm'
                                });
                            
                            if (!error) {
                                console.log('✅ Video uploaded successfully:', fileName);
                            } else {
                                console.error('❌ Video upload failed:', error);
                            }
                        } catch (err) {
                            console.error('❌ Video upload error:', err);
                        }
                    }
                    
                    // Clean up stream
                    if (state.videoStream) {
                        state.videoStream.getTracks().forEach(track => track.stop());
                    }
                    
                    // Hide preview
                    const preview = document.getElementById('webcamPreview');
                    if (preview) {
                        preview.classList.add('hidden');
                    }
                };
                
                state.mediaRecorder.start(1000); // Record in 1-second chunks
                
            } catch (error) {
                console.error('Webcam setup failed:', error);
                showToast('Camera Error', 'Could not access camera. Assessment will continue without recording.', 'warning');
            }
        }

        // Enhanced Cheating Detection
        function setupCheatingDetection() {
            const logCheatingEvent = (event, details = {}) => {
                const log = {
                    event,
                    timestamp: new Date().toISOString(),
                    details
                };
                state.cheatingLogs.push(log);
                
                if (state.currentScreen === 'assessment') {
                    showCheatingWarning(event);
                }
            };
            
            // Tab/Window focus detection
            let blurTimeout;
            window.addEventListener('blur', () => {
                if (state.currentScreen === 'assessment') {
                    blurTimeout = setTimeout(() => {
                        logCheatingEvent('window_blur', { duration: 'extended' });
                        showSecurityAlert('Window Focus Lost', 'You switched away from the assessment window. This has been logged as a security event.');
                    }, 1000);
                }
            });
            
            window.addEventListener('focus', () => {
                if (blurTimeout) {
                    clearTimeout(blurTimeout);
                    blurTimeout = null;
                }
            });
            
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && state.currentScreen === 'assessment') {
                    logCheatingEvent('tab_hidden');
                    showSecurityAlert('Tab Hidden', 'You switched to another tab or minimized the window. This has been logged as a security event.');
                }
            });
            
            // Enhanced mouse tracking
            let mouseTrackingTimeout;
            
            document.addEventListener('mouseleave', (e) => {
                if (state.currentScreen === 'assessment') {
                    // Only log if mouse actually leaves the document bounds
                    if (e.clientY < 0 || e.clientX < 0 || 
                        e.clientX > window.innerWidth || e.clientY > window.innerHeight) {
                        
                        mouseTrackingTimeout = setTimeout(() => {
                            logCheatingEvent('mouse_left_screen', { 
                                position: { x: e.clientX, y: e.clientY },
                                windowSize: { width: window.innerWidth, height: window.innerHeight }
                            });
                        }, 500);
                    }
                }
            });
            
            document.addEventListener('mouseenter', () => {
                if (mouseTrackingTimeout) {
                    clearTimeout(mouseTrackingTimeout);
                    mouseTrackingTimeout = null;
                }
            });
            
            // Keyboard shortcuts detection
            document.addEventListener('keydown', (e) => {
                if (state.currentScreen !== 'assessment') return;
                
                const suspiciousKeys = ['F12', 'F5'];
                const suspiciousCombos = [
                    { ctrl: true, shift: true, key: 'I' },
                    { ctrl: true, shift: true, key: 'J' },
                    { ctrl: true, key: 'U' },
                    { ctrl: true, key: 'R' },
                    { altKey: true, key: 'Tab' },
                    { metaKey: true, key: 'r' },
                    { metaKey: true, key: 'j' }
                ];
                
                if (suspiciousKeys.includes(e.key)) {
                    e.preventDefault();
                    logCheatingEvent('suspicious_key', { key: e.key });
                }
                
                for (const combo of suspiciousCombos) {
                    const matchesCombo = Object.keys(combo).every(prop => {
                        if (prop === 'key') return e.key === combo[prop];
                        return e[prop] === combo[prop];
                    });
                    
                    if (matchesCombo) {
                        e.preventDefault();
                        logCheatingEvent('suspicious_key_combo', combo);
                        showSecurityAlert('Blocked Action', 'Developer tools and system shortcuts are disabled during the assessment.');
                        break;
                    }
                }
            });
            
            // Right-click detection
            document.addEventListener('contextmenu', (e) => {
                if (state.currentScreen === 'assessment') {
                    e.preventDefault();
                    logCheatingEvent('context_menu_attempt', { 
                        position: { x: e.clientX, y: e.clientY } 
                    });
                }
            });
            
            // Copy/Paste detection
            document.addEventListener('copy', (e) => {
                if (state.currentScreen === 'assessment') {
                    logCheatingEvent('copy_attempt');
                }
            });
            
            document.addEventListener('paste', (e) => {
                if (state.currentScreen === 'assessment') {
                    // Allow paste in code editor, but log it
                    if (e.target.closest('.CodeMirror')) {
                        logCheatingEvent('paste_in_editor', { 
                            dataLength: e.clipboardData?.getData('text')?.length || 0 
                        });
                    } else {
                        logCheatingEvent('paste_attempt');
                    }
                }
            });
            
            // Screen size change detection
            let initialScreenSize = { width: window.screen.width, height: window.screen.height };
            
            window.addEventListener('resize', () => {
                if (state.currentScreen === 'assessment') {
                    const currentSize = { width: window.screen.width, height: window.screen.height };
                    if (currentSize.width !== initialScreenSize.width || currentSize.height !== initialScreenSize.height) {
                        logCheatingEvent('screen_size_change', { 
                            from: initialScreenSize, 
                            to: currentSize 
                        });
                        initialScreenSize = currentSize;
                    }
                }
            });

            // Fullscreen exit detection
            document.addEventListener('fullscreenchange', () => {
                if (state.currentScreen === 'assessment' && !document.fullscreenElement) {
                    logCheatingEvent('fullscreen_exit');
                }
            });
        }

        function showCheatingWarning(eventType) {
            const warnings = {
                'window_blur': 'You switched away from the assessment window!',
                'tab_hidden': 'You switched to another tab!',
                'mouse_left_screen': 'Keep your cursor within the assessment window!',
                'context_menu_attempt': 'Right-click is disabled during assessment!',
                'suspicious_key': 'That key combination is not allowed!',
                'suspicious_key_combo': 'Developer tools access is prohibited!',
                'copy_attempt': 'Copying content is being monitored',
                'paste_attempt': 'Pasting content outside the editor is not allowed',
                'paste_in_editor': 'Code paste detected and logged',
                'screen_size_change': 'Screen configuration change detected',
                'fullscreen_exit': 'Fullscreen mode exit detected'
            };
            
            const message = warnings[eventType] || 'Suspicious activity detected!';
            showToast('Security Alert', message, 'error', 5000);
        }

        // Timer Functions
        function startTimer(seconds) {
            state.timeLeft = seconds;
            updateTimerDisplay();
            
            state.timer = setInterval(() => {
                state.timeLeft--;
                updateTimerDisplay();
                
                if (state.timeLeft <= 0) {
                    clearInterval(state.timer);
                    showToast('Time Up', 'Time has expired. Submitting your assessment automatically.', 'warning', 0);
                    setTimeout(() => submitAssessment(), 2000);
                } else if (state.timeLeft === 300) { // 5 minutes warning
                    showToast('Time Warning', 'Only 5 minutes remaining!', 'warning', 5000);
                } else if (state.timeLeft === 60) { // 1 minute warning
                    showToast('Final Warning', 'Only 1 minute remaining!', 'error', 5000);
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const hours = Math.floor(state.timeLeft / 3600);
            const minutes = Math.floor((state.timeLeft % 3600) / 60);
            const seconds = state.timeLeft % 60;
            
            const display = hours > 0 
                ? `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
                : `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const timerElement = document.getElementById('timeDisplay');
            const timerContainer = document.getElementById('timer');
            if (timerElement && timerContainer) {
                timerElement.textContent = display;
                
                if (state.timeLeft < 60) { // Less than 1 minute
                    timerContainer.className = 'timer danger';
                } else if (state.timeLeft < 300) { // Less than 5 minutes
                    timerContainer.className = 'timer warning';
                } else {
                    timerContainer.className = 'timer';
                }
            }
        }

        // Utility Functions
        function calculateTimeTaken() {
            const totalAllocated = (state.assessmentDuration || 60) * 60;
            return totalAllocated - state.timeLeft;
        }

        function calculateScore() {
            // Basic scoring - count answered questions
            const answeredQuestions = state.answers.filter(a => a && a.trim()).length;
            const totalQuestions = state.questions.length;
            return Math.round((answeredQuestions / totalQuestions) * 100);
        }

        async function getInvitationId() {
            if (!state.invitationToken || !state.supabaseClient) return null;
            
            try {
                const { data, error } = await state.supabaseClient
                    .from('invitations')
                    .select('id')
                    .eq('invitation_token', state.invitationToken)
                    .single();
                
                return error ? null : data.id;
            } catch {
                return null;
            }
        }

        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch {
                return null;
            }
        }

        function generateBrowserFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Browser fingerprint text', 2, 2);
            
            return {
                canvas: canvas.toDataURL(),
                screen: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language,
                platform: navigator.platform,
                cookieEnabled: navigator.cookieEnabled,
                doNotTrack: navigator.doNotTrack
            };
        }

        // Initialize Application
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Validate and load assessment
                showToast('Loading', 'Initializing assessment...', 'info');
                
                const assessmentInfo = await validateAndLoadAssessment();
                
                if (assessmentInfo) {
                    state.assessmentInfo = assessmentInfo;
                    showScreen('welcome');
                    showToast('Ready', 'Assessment loaded successfully!', 'success', 3000);
                } else {
                    // Error screen already shown by validateAndLoadAssessment
                    return;
                }
                
            } catch (error) {
                console.error('Failed to initialize application:', error);
                showErrorScreen('Initialization Error', 'Failed to load assessment. Please refresh the page and try again.');
            }
        });

        // Prevent navigation away from assessment
        window.addEventListener('beforeunload', (e) => {
            if (state.currentScreen === 'assessment') {
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave? Your progress may be lost.';
                return e.returnValue;
            }
        });

        // Prevent back button during assessment
        window.addEventListener('popstate', (e) => {
            if (state.currentScreen === 'assessment') {
                e.preventDefault();
                history.pushState(null, null, location.href);
                showToast('Navigation Blocked', 'You cannot navigate away during the assessment.', 'warning');
            }
        });

        // Push initial state to prevent back button
        history.pushState(null, null, location.href);

        // Clean up resources on page unload
        window.addEventListener('unload', () => {
            if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                state.mediaRecorder.stop();
            }
            
            if (state.videoStream) {
                state.videoStream.getTracks().forEach(track => track.stop());
            }
            
            if (state.timer) {
                clearInterval(state.timer);
            }
        });

        // Disable common cheating attempts
        document.addEventListener('selectstart', (e) => {
            if (state.currentScreen === 'assessment' && !e.target.closest('.CodeMirror')) {
                e.preventDefault();
            }
        });

        document.addEventListener('dragstart', (e) => {
            if (state.currentScreen === 'assessment') {
                e.preventDefault();
            }
        });

        // Disable print
        window.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'p' && state.currentScreen === 'assessment') {
                e.preventDefault();
                showToast('Action Blocked', 'Printing is not allowed during assessment.', 'error');
            }
        });

        // Handle ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.confirmation-modal, .security-alert').forEach(modal => {
                    modal.remove();
                });
            }
        });
    </script>
</body>
</html>
