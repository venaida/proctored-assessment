<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechAssess Pro - Assessment Platform</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/github.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #1a1a1a; --primary-hover: #2a2a2a; --secondary: #f8f9fa; --accent: #e9ecef; --success: #22c55e; --warning: #f59e0b; --error: #ef4444; --text-primary: #1a1a1a; --text-secondary: #6b7280; --border: #e5e7eb; --radius: 8px; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: var(--text-primary); line-height: 1.6; min-height: 100vh; overflow: hidden; }
        .custom-toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 12px; }
        .custom-toast { background: white; border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12); min-width: 320px; max-width: 400px; display: flex; align-items: flex-start; gap: 12px; animation: slideInRight 0.3s ease; font-family: inherit; }
        .custom-toast.success { border-left: 4px solid var(--success); }
        .custom-toast.warning { border-left: 4px solid var(--warning); }
        .custom-toast.error { border-left: 4px solid var(--error); }
        .custom-toast.info { border-left: 4px solid var(--primary); }
        .custom-toast-content { flex: 1; }
        .custom-toast-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .custom-toast-message { font-size: 13px; color: var(--text-secondary); }
        .custom-toast-close { background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-secondary); opacity: 0.7; transition: opacity 0.2s; }
        .custom-toast-close:hover { opacity: 1; }
        .confirmation-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 10001; animation: fadeIn 0.2s ease; }
        .confirmation-content { background: white; border-radius: var(--radius); padding: 32px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); animation: scaleIn 0.3s ease; }
        .confirmation-icon { width: 60px; height: 60px; margin: 0 auto 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; }
        .confirmation-icon.warning { background: var(--warning); }
        .confirmation-icon.error { background: var(--error); }
        .confirmation-icon.info { background: var(--primary); }
        .confirmation-title { font-size: 20px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary); }
        .confirmation-message { color: var(--text-secondary); margin-bottom: 24px; line-height: 1.5; }
        .confirmation-buttons { display: flex; gap: 12px; justify-content: center; }
        .webcam-preview { position: fixed; bottom: 20px; left: 20px; width: 200px; height: 150px; border: 3px solid var(--primary); border-radius: var(--radius); overflow: hidden; background: black; z-index: 999; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); transition: opacity 0.3s ease; }
        .webcam-preview video { width: 100%; height: 100%; object-fit: cover; }
        .webcam-preview::after { content: "Recording"; position: absolute; top: 8px; left: 8px; background: var(--error); color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        #app { height: 100vh; overflow-y: auto; }
        .container { max-width: 800px; margin: 0 auto; padding: 40px 20px; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .card { background: white; border-radius: var(--radius); overflow: hidden; width: 100%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2); }
        .card-header { background: var(--secondary); padding: 32px; text-align: center; border-bottom: 1px solid var(--border); }
        .brand-header { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 20px; }
        .brand-logo { width: 60px; height: 60px; background: var(--primary); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 24px; }
        .card-header h1 { font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; }
        .card-header p { color: var(--text-secondary); font-size: 16px; }
        .card-body { padding: 32px; }
        .form-group { margin-bottom: 24px; }
        .form-label { display: block; font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 8px; }
        .form-input { width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: var(--radius); font-size: 16px; background: white; transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.1); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 16px 24px; border: none; border-radius: var(--radius); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; min-height: 48px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(26, 26, 26, 0.2); }
        .btn-secondary { background: white; color: var(--text-primary); border: 2px solid var(--border); }
        .btn-secondary:hover { background: var(--secondary); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #16a34a; transform: translateY(-2px); box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3); }
        .btn-group { display: flex; gap: 16px; justify-content: center; margin-top: 32px; }
        .info-box { background: var(--accent); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin: 20px 0; }
        .warning-box { background: #fef3c7; border: 1px solid #f59e0b; border-left: 4px solid #f59e0b; border-radius: var(--radius); padding: 20px; margin: 20px 0; }
        .warning-box h3 { color: #92400e; font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .instructions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin: 24px 0; }
        .instruction-item { background: var(--secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
        .instruction-item h3 { font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .assessment-container { background: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .assessment-header { background: white; border-bottom: 2px solid var(--border); padding: 20px 32px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); flex-shrink: 0; }
        .assessment-info h2 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
        .assessment-info p { font-size: 14px; color: var(--text-secondary); }
        .assessment-controls { display: flex; align-items: center; gap: 20px; }
        .timer { background: var(--success); color: white; padding: 12px 20px; border-radius: 24px; font-weight: 700; font-family: monospace; font-size: 16px; }
        .timer.warning { background: var(--warning); color: var(--text-primary); }
        .timer.danger { background: var(--error); }
        .recording-indicator { background: var(--error); color: white; padding: 12px 20px; border-radius: 24px; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .recording-dot { width: 10px; height: 10px; background: white; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .assessment-content { flex: 1; display: flex; overflow: hidden; }
        .questions-panel { width: 360px; background: var(--secondary); border-right: 2px solid var(--border); padding: 24px; overflow-y: auto; flex-shrink: 0; }
        .question-nav { display: grid; grid-template-columns: repeat(auto-fill, minmax(48px, 1fr)); gap: 12px; margin-bottom: 32px; }
        .question-nav-item { width: 48px; height: 48px; border: 2px solid var(--border); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: 700; font-size: 16px; background: white; transition: all 0.2s; }
        .question-nav-item.active { background: var(--primary); color: white; border-color: var(--primary); }
        .question-nav-item.answered { background: var(--success); color: white; border-color: var(--success); }
        .current-question { background: white; border: 2px solid var(--border); border-radius: var(--radius); padding: 24px; }
        .current-question h3 { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--text-primary); }
        .current-question p { color: var(--text-secondary); line-height: 1.7; margin-bottom: 20px; }
        .test-cases { margin-top: 20px; }
        .test-case { background: var(--accent); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; font-family: 'Monaco', 'Consolas', monospace; font-size: 14px; }
        .editor-panel { flex: 1; display: flex; flex-direction: column; background: white; overflow: hidden; }
        .editor-header { padding: 16px 24px; background: var(--secondary); border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .editor-tab { background: white; border: 2px solid var(--border); border-radius: var(--radius); padding: 8px 16px; font-size: 14px; font-weight: 600; }
        #codeEditor { flex-grow: 1; position: relative; overflow: auto; }
        .CodeMirror { position: absolute; top: 0; left: 0; right: 0; bottom: 0; height: 100%; font-size: 16px; font-family: 'Monaco', 'Consolas', monospace; }
        .status-bar { padding: 16px 24px; background: var(--secondary); border-top: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: var(--text-secondary); flex-shrink: 0; }
        .success-screen { text-align: center; padding: 48px 32px; }
        .success-icon { width: 80px; height: 80px; background: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; color: white; font-size: 32px; }
        .hidden { display: none !important; }
        @media (max-width: 768px) {
            .container { padding: 20px 10px; }
            .assessment-content { flex-direction: column; }
            .questions-panel { width: 100%; max-height: 40vh; border-right: none; border-bottom: 2px solid var(--border); }
            .btn-group { flex-direction: column; }
            .webcam-preview { width: 120px; height: 90px; bottom: 10px; left: 10px; }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="customToastContainer" class="custom-toast-container"></div>
    <div id="modalContainer"></div>
    <div id="webcamPreview" class="webcam-preview hidden"><video id="webcamVideo" autoplay muted></video></div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script>
        // --- CONFIGURATION & STATE ---
        const CONFIG = {
            supabaseUrl: "https://ytoidmelmialrjfqyhet.supabase.co",
            supabaseAnonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0b2lkbWVsbWlhbHJqZnF5aGV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2ODcwNjI1NDIsImV4cCI6MjAwMjYzODU0Mn0.SoE9K21U9U1U82r2GA9i68gH_S5MASEI4h0e5mJg0yc",
            brandName: "TechAssess Pro",
            brandLogo: "TA"
        };
        const state = { currentScreen: 'loading', currentUser: null, currentQuestion: 0, answers: [], cheatingLogs: [], mediaRecorder: null, videoChunks: [], webcamStream: null, editors: {}, timer: null, timeLeft: 0, assessmentData: null, isModalOpen: false, invitationToken: null };
        const supabaseClient = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseAnonKey);

        // --- UI COMPONENTS ---
        function showCustomToast(title, message, type = 'info', duration = 5000) {
            const container = document.getElementById('customToastContainer');
            const toast = document.createElement('div');
            toast.className = `custom-toast ${type}`;
            toast.innerHTML = `<div class="custom-toast-content"><div class="custom-toast-title">${title}</div><p class="custom-toast-message">${message}</p></div><button class="custom-toast-close" onclick="this.parentElement.remove()">&times;</button>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), duration);
        }

        function showCustomConfirm(title, message, onConfirm, type = 'warning') {
            if(state.isModalOpen) return;
            state.isModalOpen = true;
            const container = document.getElementById('modalContainer');
            const modal = document.createElement('div');
            modal.className = 'confirmation-modal';
            modal.innerHTML = `
                <div class="confirmation-content">
                    <div class="confirmation-icon ${type}"><i class="fas fa-exclamation-triangle"></i></div>
                    <h2 class="confirmation-title">${title}</h2>
                    <p class="confirmation-message">${message}</p>
                    <div class="confirmation-buttons">
                        <button id="confirmCancel" class="btn btn-secondary">Cancel</button>
                        <button id="confirmAction" class="btn btn-primary">Confirm</button>
                    </div>
                </div>`;
            container.appendChild(modal);
            document.getElementById('confirmAction').onclick = () => { onConfirm(); modal.remove(); state.isModalOpen = false; };
            document.getElementById('confirmCancel').onclick = () => { modal.remove(); state.isModalOpen = false; };
        }

        // --- WEBCAM & PROCTORING ---
        async function setupWebcam() {
            try {
                state.webcamStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                const videoEl = document.getElementById('webcamVideo');
                videoEl.srcObject = state.webcamStream;
                document.getElementById('webcamPreview').classList.remove('hidden');

                state.mediaRecorder = new MediaRecorder(state.webcamStream, { mimeType: 'video/webm' });
                state.mediaRecorder.ondataavailable = e => e.data.size > 0 && state.videoChunks.push(e.data);
                state.mediaRecorder.start(1000);
            } catch(err) {
                console.error("Webcam error:", err);
                showScreen('error', { title: 'Webcam Required', message: 'This assessment requires camera and microphone access. Please enable permissions and refresh.'});
                throw err;
            }
        }

        function stopWebcam() {
            if(state.webcamStream) {
                state.webcamStream.getTracks().forEach(track => track.stop());
            }
            if(state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                state.mediaRecorder.stop();
            }
            document.getElementById('webcamPreview').classList.add('hidden');
        }
        
        function setupCheatingDetection() {
            const log = (event, details={}) => {
                state.cheatingLogs.push({ event, timestamp: new Date().toISOString(), details });
                showCheatingWarning(event);
            };
            window.addEventListener('blur', () => log('window_blur'));
            document.addEventListener('visibilitychange', () => document.hidden && log('tab_hidden'));
            window.addEventListener('contextmenu', e => { e.preventDefault(); log('context_menu'); });
            document.addEventListener('keydown', e => {
                 if (e.key === 'F12' || (e.ctrlKey && e.shiftKey)) { e.preventDefault(); log('devtools_key'); }
            });
        }
        
        function showCheatingWarning(eventType) {
            let message = "Suspicious activity detected. Please focus on the assessment.";
            if(eventType === 'tab_hidden') message = 'Tab switched. Please remain in the assessment window.';
            if(eventType === 'window_blur') message = 'Window lost focus. Please stay on this page.';
            showCustomToast('Security Alert', message, 'warning');
        }

        // --- SCREEN RENDERING ---
        function showScreen(screenName, data = {}) {
            state.currentScreen = screenName;
            const app = document.getElementById('app');
            app.innerHTML = '';
            
            switch (screenName) {
                case 'loading': app.innerHTML = renderLoadingScreen(); break;
                case 'error': app.innerHTML = renderErrorScreen(data.title, data.message); break;
                case 'welcome': app.innerHTML = renderWelcomeScreen(); break;
                case 'instructions': app.innerHTML = renderInstructionsScreen(); break;
                case 'assessment': app.innerHTML = renderAssessmentScreen(); setTimeout(initializeAssessment, 0); break;
                case 'success': app.innerHTML = renderSuccessScreen(); stopWebcam(); break;
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderLoadingScreen() { return `<div class="container"><div class="card"><div class="card-body" style="text-align:center;">Loading Assessment...</div></div></div>`; }
        function renderErrorScreen(title, message) { return `<div class="container"><div class="card"><div class="card-body" style="text-align: center;"><div class="confirmation-icon error" style="margin-top:0;"><i class="fas fa-times-circle"></i></div><h1 style="font-size: 24px;">${title}</h1><p style="color: var(--text-secondary);">${message}</p></div></div></div>`; }
        
        function renderWelcomeScreen() {
            const data = state.assessmentData;
            return `<div class="container"><div class="card"><div class="card-header"><div class="brand-header"><div class="brand-logo">${CONFIG.brandLogo}</div></div><h1>${data?.title ?? 'Assessment'}</h1><p>${data?.description ?? 'Please enter your details to begin.'}</p></div><div class="card-body"><div class="info-box"><h3><i class="fas fa-info-circle"></i> Details</h3><p><strong>Duration:</strong> ${data?.duration ?? 'N/A'} mins | <strong>Questions:</strong> ${data?.questions?.length ?? 0} | <strong>Language:</strong> ${data?.language ?? 'N/A'}</p></div><div class="form-group"><label class="form-label">Full Name</label><input type="text" id="candidateName" class="form-input" placeholder="Enter your full name" required></div><div class="form-group"><label class="form-label">Email Address</label><input type="email" id="candidateEmail" class="form-input" placeholder="Enter your email address" required></div><div class="btn-group"><button class="btn btn-primary" onclick="proceedToInstructions()"><i class="fas fa-arrow-right"></i> Continue</button></div></div></div></div>`;
        }

        function renderInstructionsScreen() {
             return `<div class="container"><div class="card"><div class="card-header"><h1>Instructions</h1><p>Read carefully before you begin.</p></div><div class="card-body"><div class="instructions-grid"><div class="instruction-item"><h3><i class="fas fa-video"></i> Webcam Proctoring</h3><p>Your webcam and microphone will be recorded throughout the assessment.</p></div><div class="instruction-item"><h3><i class="fas fa-clock"></i> Time Limit</h3><p>You have a fixed time to complete the assessment. The timer cannot be paused.</p></div><div class="instruction-item"><h3><i class="fas fa-desktop"></i> Focus Required</h3><p>Do not switch tabs or navigate away from the assessment window.</p></div></div><div class="warning-box"><h3><i class="fas fa-exclamation-triangle"></i> Important</h3><p>Clicking "Start Assessment" will immediately begin the timer and recording.</p></div><div class="btn-group"><button class="btn btn-success" onclick="startAssessment()"><i class="fas fa-play-circle"></i> Start Assessment</button></div></div></div></div>`;
        }
        
        function renderAssessmentScreen() {
            const q = state.assessmentData.questions[state.currentQuestion];
            return `
            <div class="assessment-container">
                <header class="assessment-header">
                    <div class="assessment-info"><h2>${state.assessmentData.title}</h2><p>${state.currentUser.name}</p></div>
                    <div class="assessment-controls">
                        <div id="timer" class="timer">00:00</div>
                        <div class="recording-indicator"><div class="recording-dot"></div>Recording</div>
                    </div>
                </header>
                <div class="assessment-content">
                    <div class="questions-panel">
                        <h3>Questions</h3>
                        <div id="questionNav" class="question-nav"></div>
                        <div class="current-question">
                            <h3>${q.title}</h3><p>${q.description}</p>
                        </div>
                    </div>
                    <div class="editor-panel">
                        <div class="editor-header"><div class="editor-tab">Solution</div><button class="btn btn-secondary btn-sm" onclick="showConfirmSubmission()">Submit</button></div>
                        <div id="codeEditor"></div>
                        <div class="status-bar"><span>Language: ${q.language}</span><span>Auto-saved</span></div>
                    </div>
                </div>
            </div>`;
        }

        function renderSuccessScreen() {
            return `<div class="container"><div class="card"><div class="card-body success-screen"><div class="success-icon"><i class="fas fa-check"></i></div><h1>Assessment Submitted!</h1><p>Your responses have been successfully submitted. You may now close this window.</p></div></div></div>`;
        }
        
        // --- ASSESSMENT LOGIC ---
        async function initializeAssessment() {
            updateQuestionNavigation();
            const q = state.assessmentData.questions[state.currentQuestion];
            state.editors[state.currentQuestion] = CodeMirror(document.getElementById('codeEditor'), {
                value: state.answers[state.currentQuestion] || q.starter || '',
                mode: q.language,
                theme: 'github',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true
            });
            state.editors[state.currentQuestion].on('change', cm => {
                state.answers[state.currentQuestion] = cm.getValue();
                updateQuestionNavigation();
            });
            startTimer(state.assessmentData.duration * 60);
        }
        
        function switchQuestion(index) {
            if(index === state.currentQuestion || !state.editors[state.currentQuestion]) return;
            state.currentQuestion = index;
            renderAssessmentScreen();
        }

        function updateQuestionNavigation() {
            const nav = document.getElementById('questionNav');
            if(!nav) return;
            nav.innerHTML = state.assessmentData.questions.map((_, i) => 
                `<div class="question-nav-item ${i === state.currentQuestion ? 'active' : ''} ${state.answers[i] ? 'answered' : ''}" onclick="switchQuestion(${i})">${i + 1}</div>`
            ).join('');
        }
        
        function startTimer(seconds) {
            state.timeLeft = seconds;
            state.timer = setInterval(() => {
                state.timeLeft--;
                const mins = String(Math.floor(state.timeLeft / 60)).padStart(2, '0');
                const secs = String(state.timeLeft % 60).padStart(2, '0');
                const timerEl = document.getElementById('timer');
                if(timerEl) timerEl.textContent = `${mins}:${secs}`;

                if(state.timeLeft <= 0) {
                    clearInterval(state.timer);
                    submitAssessment();
                } else if(state.timeLeft < 300) {
                    timerEl.className = 'timer danger';
                } else if(state.timeLeft < 600) {
                    timerEl.className = 'timer warning';
                }
            }, 1000);
        }

        function showConfirmSubmission() {
            showCustomConfirm('Submit Assessment?', 'Are you sure you want to finalize and submit your answers?', submitAssessment);
        }
        
        async function submitAssessment() {
            clearInterval(state.timer);
            stopWebcam();
            showScreen('loading');

            const blob = new Blob(state.videoChunks, { type: 'video/webm' });
            const videoFileName = `recording-${state.invitationToken || Date.now()}.webm`;
            await supabaseClient.storage.from('recordings').upload(videoFileName, blob);
            
            const { error } = await supabaseClient.from('submissions').insert({
                invitation_id: state.assessmentData.invitation_id,
                candidate_name: state.currentUser.name,
                candidate_email: state.currentUser.email,
                answers: state.answers,
                cheating_logs: state.cheatingLogs,
                video_url: videoFileName,
                assessment_template_id: state.assessmentData.id
            });

            if(state.invitationToken) {
                await supabaseClient.from('invitations').update({ status: 'completed' }).eq('invitation_token', state.invitationToken);
            }

            if(error) {
                showScreen('error', { title: 'Submission Failed', message: 'There was an error submitting your assessment.' });
            } else {
                showScreen('success');
            }
        }
        
        function proceedToInstructions() {
            const name = document.getElementById('candidateName').value;
            const email = document.getElementById('candidateEmail').value;
            if(!name || !email) return showCustomToast('Error', 'Please fill in your name and email.', 'error');
            state.currentUser = { name, email };
            showScreen('instructions');
        }

        async function startAssessment() {
            try {
                await setupWebcam();
                setupCheatingDetection();
                state.answers = Array(state.assessmentData.questions.length).fill('');
                showScreen('assessment');
            } catch (err) {
                 // Error is handled in setupWebcam
            }
        }

        // --- INITIALIZATION & ROUTING ---
        async function validateAndLoadAssessment() {
            showScreen('loading');
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            state.invitationToken = token;

            if (!token) {
                state.assessmentData = getDefaultAssessment();
                return showScreen('welcome');
            }

            try {
                const { data: invitation, error } = await supabaseClient.from('invitations').select('*, assessment_templates(*)').eq('invitation_token', token).single();
                
                if (error || !invitation) return showScreen('error', { title: 'Invalid Link', message: 'This assessment link is not valid or has been used.' });
                if (invitation.status !== 'sent') return showScreen('error', { title: 'Link Used', message: 'This assessment has already been completed.' });
                if (new Date(invitation.expires_at) < new Date()) return showScreen('error', { title: 'Link Expired', message: 'The deadline for this assessment has passed.' });

                state.assessmentData = {
                    ...invitation.assessment_templates,
                    duration: invitation.duration || invitation.assessment_templates.default_duration,
                    invitation_id: invitation.id
                };
                showScreen('welcome');
            } catch (err) {
                console.error("Failed to load assessment:", err);
                showScreen('error', { title: 'Error', message: 'Could not load the assessment data.' });
            }
        }

        function getDefaultAssessment() {
            return { id: 'js-demo', title: 'JavaScript Demo', description: 'A sample assessment for demonstration.', duration: 15, language: 'javascript', questions: [{ id: 1, title: "Sum Array", description: "Write a function that sums all numbers in an array.", language: "javascript", starter: "function sum(arr) {\n  // your code here\n}" }] };
        }

        document.addEventListener('DOMContentLoaded', validateAndLoadAssessment);
    </script>
</body>
</html>
