<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechAssess Pro - Assessment Platform</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/github.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #1a1a1a; --primary-hover: #2a2a2a; --secondary: #f8f9fa; --accent: #e9ecef; --success: #22c55e; --warning: #f59e0b; --error: #ef4444; --text-primary: #1a1a1a; --text-secondary: #6b7280; --border: #e5e7eb; --radius: 8px; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: var(--text-primary); line-height: 1.6; min-height: 100vh; overflow: hidden; }
        .custom-toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 12px; }
        .custom-toast { background: white; border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12); min-width: 320px; max-width: 400px; display: flex; align-items: flex-start; gap: 12px; animation: slideInRight 0.3s ease; font-family: inherit; }
        .custom-toast.success { border-left: 4px solid var(--success); }
        .custom-toast.warning { border-left: 4px solid var(--warning); }
        .custom-toast.error { border-left: 4px solid var(--error); }
        .custom-toast.info { border-left: 4px solid var(--primary); }
        .custom-toast-content { flex: 1; }
        .custom-toast-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .custom-toast-message { font-size: 13px; color: var(--text-secondary); }
        .custom-toast-close { background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-secondary); opacity: 0.7; transition: opacity 0.2s; }
        .custom-toast-close:hover { opacity: 1; }
        .confirmation-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 10001; animation: fadeIn 0.2s ease; }
        .confirmation-content { background: white; border-radius: var(--radius); padding: 32px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); animation: scaleIn 0.3s ease; }
        .confirmation-icon { width: 60px; height: 60px; margin: 0 auto 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; }
        .confirmation-icon.warning { background: var(--warning); }
        .confirmation-icon.error { background: var(--error); }
        .confirmation-icon.info { background: var(--primary); }
        .confirmation-title { font-size: 20px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary); }
        .confirmation-message { color: var(--text-secondary); margin-bottom: 24px; line-height: 1.5; }
        .confirmation-buttons { display: flex; gap: 12px; justify-content: center; }
        .webcam-preview { position: fixed; bottom: 20px; left: 20px; width: 200px; height: 150px; border: 3px solid var(--primary); border-radius: var(--radius); overflow: hidden; background: black; z-index: 999; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); transition: opacity 0.3s ease; }
        .webcam-preview video { width: 100%; height: 100%; object-fit: cover; }
        .webcam-preview::after { content: "Recording"; position: absolute; top: 8px; left: 8px; background: var(--error); color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        #app { height: 100vh; overflow-y: auto; }
        .container { max-width: 800px; margin: 0 auto; padding: 40px 20px; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .card { background: white; border-radius: var(--radius); overflow: hidden; width: 100%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2); }
        .card-header { background: var(--secondary); padding: 32px; text-align: center; border-bottom: 1px solid var(--border); }
        .brand-header { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 20px; }
        .brand-logo { width: 60px; height: 60px; background: var(--primary); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 24px; }
        .card-header h1 { font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; }
        .card-header p { color: var(--text-secondary); font-size: 16px; }
        .card-body { padding: 32px; }
        .form-group { margin-bottom: 24px; }
        .form-label { display: block; font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 8px; }
        .form-input { width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: var(--radius); font-size: 16px; background: white; transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.1); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 16px 24px; border: none; border-radius: var(--radius); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; min-height: 48px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(26, 26, 26, 0.2); }
        .btn-secondary { background: white; color: var(--text-primary); border: 2px solid var(--border); }
        .btn-secondary:hover { background: var(--secondary); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #16a34a; transform: translateY(-2px); box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3); }
        .btn-group { display: flex; gap: 16px; justify-content: center; margin-top: 32px; }
        .info-box { background: var(--accent); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin: 20px 0; }
        .warning-box { background: #fef3c7; border: 1px solid #f59e0b; border-left: 4px solid #f59e0b; border-radius: var(--radius); padding: 20px; margin: 20px 0; }
        .warning-box h3 { color: #92400e; font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .instructions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin: 24px 0; }
        .instruction-item { background: var(--secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
        .instruction-item h3 { font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .assessment-container { background: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .assessment-header { background: white; border-bottom: 2px solid var(--border); padding: 20px 32px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); flex-shrink: 0; }
        .assessment-info h2 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
        .assessment-info p { font-size: 14px; color: var(--text-secondary); }
        .assessment-controls { display: flex; align-items: center; gap: 20px; }
        .timer { background: var(--success); color: white; padding: 12px 20px; border-radius: 24px; font-weight: 700; font-family: monospace; font-size: 16px; }
        .timer.warning { background: var(--warning); color: var(--text-primary); }
        .timer.danger { background: var(--error); }
        .recording-indicator { background: var(--error); color: white; padding: 12px 20px; border-radius: 24px; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .recording-dot { width: 10px; height: 10px; background: white; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .assessment-content { flex: 1; display: flex; overflow: hidden; }
        .questions-panel { width: 360px; background: var(--secondary); border-right: 2px solid var(--border); padding: 24px; overflow-y: auto; flex-shrink: 0; }
        .question-nav { display: grid; grid-template-columns: repeat(auto-fill, minmax(48px, 1fr)); gap: 12px; margin-bottom: 32px; }
        .question-nav-item { width: 48px; height: 48px; border: 2px solid var(--border); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: 700; font-size: 16px; background: white; transition: all 0.2s; }
        .question-nav-item.active { background: var(--primary); color: white; border-color: var(--primary); }
        .question-nav-item.answered { background: var(--success); color: white; border-color: var(--success); }
        .current-question { background: white; border: 2px solid var(--border); border-radius: var(--radius); padding: 24px; }
        .current-question h3 { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--text-primary); }
        .current-question p { color: var(--text-secondary); line-height: 1.7; margin-bottom: 20px; }
        .test-cases { margin-top: 20px; }
        .test-case { background: var(--accent); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; font-family: 'Monaco', 'Consolas', monospace; font-size: 14px; }
        .editor-panel { flex: 1; display: flex; flex-direction: column; background: white; overflow: hidden; }
        .editor-header { padding: 16px 24px; background: var(--secondary); border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .editor-tab { background: white; border: 2px solid var(--border); border-radius: var(--radius); padding: 8px 16px; font-size: 14px; font-weight: 600; }
        #codeEditor { flex-grow: 1; position: relative; overflow: auto; }
        .CodeMirror { position: absolute; top: 0; left: 0; right: 0; bottom: 0; height: 100%; font-size: 16px; font-family: 'Monaco', 'Consolas', monospace; }
        .status-bar { padding: 16px 24px; background: var(--secondary); border-top: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: var(--text-secondary); flex-shrink: 0; }
        .success-screen { text-align: center; padding: 48px 32px; }
        .success-icon { width: 80px; height: 80px; background: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; color: white; font-size: 32px; }
        .hidden { display: none !important; }
        @media (max-width: 768px) {
            .container { padding: 20px 10px; }
            .assessment-content { flex-direction: column; }
            .questions-panel { width: 100%; max-height: 40vh; border-right: none; border-bottom: 2px solid var(--border); }
            .btn-group { flex-direction: column; }
            .webcam-preview { width: 120px; height: 90px; bottom: 10px; left: 10px; }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="customToastContainer" class="custom-toast-container"></div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script>
        // --- CONFIGURATION & STATE ---
        const CONFIG = {
            supabaseUrl: "https://ytoidmelmialrjfqyhet.supabase.co",
            supabaseAnonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0b2lkbWVsbWlhbHJqZnF5aGV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2ODcwNjI1NDIsImV4cCI6MjAwMjYzODU0Mn0.SoE9K21U9U1U82r2GA9i68gH_S5MASEI4h0e5mJg0yc",
            brandName: "TechAssess Pro",
            brandLogo: "TA"
        };
        const state = { currentScreen: 'loading', currentUser: null, currentQuestion: 0, questions: [], answers: [], cheatingLogs: [], mediaRecorder: null, videoChunks: [], webcamStream: null, editors: {}, timer: null, timeLeft: 0, assessmentData: null, isModalOpen: false, invitationToken: null };
        const supabaseClient = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseAnonKey);

        // --- UI COMPONENTS (TOASTS & MODALS) ---
        function showCustomToast(title, message, type = 'success', duration = 5000) { /* ... implementation ... */ }
        function showCustomConfirm(title, message, type = 'warning') { /* ... implementation ... */ }

        // --- WEBCAM & PROCTORING ---
        async function setupWebcam() { /* ... implementation ... */ }
        function stopWebcam() { /* ... implementation ... */ }
        function setupCheatingDetection() { /* ... implementation ... */ }
        function showCheatingWarning(eventType) { /* ... implementation ... */ }

        // --- SCREEN RENDERING & MANAGEMENT ---
        function showScreen(screenName, data = {}) {
            state.currentScreen = screenName;
            const app = document.getElementById('app');
            app.innerHTML = ''; // Clear previous screen before rendering
            
            switch (screenName) {
                case 'loading': app.innerHTML = renderLoadingScreen(); break;
                case 'error': app.innerHTML = renderErrorScreen(data.title, data.message); break;
                case 'welcome': app.innerHTML = renderWelcomeScreen(); break;
                case 'instructions': app.innerHTML = renderInstructionsScreen(); break;
                case 'assessment': app.innerHTML = renderAssessmentScreen(); break; // Defer init
                case 'success': app.innerHTML = renderSuccessScreen(); break;
            }

            if (screenName === 'assessment') {
                // Defer initialization to ensure DOM is ready
                setTimeout(initializeAssessment, 0);
            }
            if (screenName === 'success') {
                stopWebcam();
            }
        }
        
        // --- RENDER FUNCTIONS (WITH DEFENSIVE CODING) ---
        function renderLoadingScreen() { return `<div class="container"><div class="card"><div class="card-body" style="text-align:center;">Loading Assessment...</div></div></div>`; }
        function renderErrorScreen(title, message) { return `<div class="container"><div class="card"><div class="card-body" style="text-align: center;"><div class="confirmation-icon error" style="margin-top:0;"><i class="fas fa-times-circle"></i></div><h1 style="font-size: 24px;">${title}</h1><p style="color: var(--text-secondary);">${message}</p></div></div></div>`; }
        
        // FIXED: Added defensive checks with nullish coalescing operator (??)
        function renderWelcomeScreen() {
            const data = state.assessmentData;
            return `<div class="container"><div class="card"><div class="card-header"><div class="brand-header"><div class="brand-logo">${CONFIG.brandLogo}</div></div><h1>${data?.title ?? 'Assessment'}</h1><p>${data?.description ?? 'Please enter your details to begin.'}</p></div><div class="card-body"><div class="info-box"><h3><i class="fas fa-info-circle"></i> Details</h3><p><strong>Duration:</strong> ${data?.duration ?? 'N/A'} mins | <strong>Questions:</strong> ${data?.questions?.length ?? 0} | <strong>Language:</strong> ${data?.language ?? 'N/A'}</p></div><div class="form-group"><label class="form-label">Full Name</label><input type="text" id="candidateName" class="form-input" placeholder="Enter your full name" required></div><div class="form-group"><label class="form-label">Email Address</label><input type="email" id="candidateEmail" class="form-input" placeholder="Enter your email address" required></div><div class="btn-group"><button class="btn btn-primary" onclick="proceedToInstructions()"><i class="fas fa-arrow-right"></i> Continue</button></div></div></div></div>`;
        }
        function renderInstructionsScreen() { /* ... full implementation ... */ }
        function renderAssessmentScreen() { /* ... full implementation ... */ }
        function renderSuccessScreen() { /* ... full implementation ... */ }

        // --- ASSESSMENT LOGIC ---
        async function initializeAssessment() { /* ... full implementation ... */ }
        function switchQuestion(index) { /* ... full implementation ... */ }
        function updateQuestionNavigation() { /* ... full implementation ... */ }
        function startTimer(seconds) { /* ... full implementation ... */ }
        async function showConfirmSubmission() { /* ... full implementation ... */ }
        async function submitAssessment() { /* ... full implementation ... */ }
        function proceedToInstructions() { /* ... full implementation ... */ }
        function startAssessment() { /* ... full implementation ... */ }

        // --- INITIALIZATION & ROUTING ---
        async function validateAndLoadAssessment() {
            showScreen('loading');
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            state.invitationToken = token;

            if (!token) {
                state.assessmentData = getDefaultAssessment();
                return showScreen('welcome');
            }

            try {
                const { data: invitation, error } = await supabaseClient.from('invitations').select('*, assessment_templates(*)').eq('invitation_token', token).single();
                
                if (error || !invitation) return showScreen('error', { title: 'Invalid Link', message: 'This assessment link is not valid or has been used.' });
                if (invitation.status !== 'sent') return showScreen('error', { title: 'Link Used', message: 'This assessment has already been completed.' });
                if (new Date(invitation.expires_at) < new Date()) return showScreen('error', { title: 'Link Expired', message: 'The deadline for this assessment has passed.' });

                state.assessmentData = {
                    ...invitation.assessment_templates,
                    duration: invitation.duration || invitation.assessment_templates.default_duration,
                };
                showScreen('welcome');
            } catch (err) {
                console.error("Failed to load assessment:", err);
                showScreen('error', { title: 'Error', message: 'Could not load the assessment data.' });
            }
        }

        function getDefaultAssessment() {
            return { id: 'js-demo', title: 'JavaScript Demo', description: 'A sample assessment.', duration: 15, language: 'JavaScript', questions: [{ id: 1, title: "Sum Array", description: "Sum all numbers in an array.", language: "javascript", starter: "function sum(arr) {\n  // code\n}" }] };
        }

        document.addEventListener('DOMContentLoaded', validateAndLoadAssessment);
    </script>
</body>
</html>
